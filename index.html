<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìª¼ê°œê¸° ë§ˆìŠ¤í„° (Jjokegi Master)</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --primary-color: #4A80F3;
            --danger-color: #D93025;
            --text-color: #333333;
            --subtext-color: #555555;
            --bg-color: #FFFFFF;
            --border-color: #DDDDDD;
            --light-bg: #f9f9f9;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            font-size: 16px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        header {
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 40px;
        }
        header h1 {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.2;
        }
        header p {
            font-size: 18px;
            color: var(--subtext-color);
            margin-top: 16px;
        }
        .step-box {
            margin-bottom: 40px;
        }
        .step-box h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }
        
        /* 1ë‹¨ê³„: ì…ë ¥í¼ ìŠ¤íƒ€ì¼ */
        textarea {
            width: 100%;
            min-height: 250px;
            padding: 16px;
            font-family: "Pretendard", sans-serif;
            font-size: 16px;
            line-height: 1.7;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
        }
        .input-group {
            margin-top: 24px;
        }
        .input-group label {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            display: block;
        }
        .input-group input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            font-family: "Pretendard", sans-serif;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .api-key-warning {
            font-size: 13px;
            color: var(--subtext-color);
            background-color: var(--light-bg);
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .course-options {
            margin-top: 24px;
            display: grid; /* Flex ëŒ€ì‹  Grid ì‚¬ìš© (2ì—´) */
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .course-options label {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .course-options label:hover {
            border-color: #a0b7e8;
        }
        .course-options input[type="radio"]:checked + span {
            font-weight: 700;
            color: var(--primary-color);
        }
        .course-options input[type="radio"]:checked + span + label {
             border-color: var(--primary-color);
             box-shadow: 0 4px 12px rgba(74, 128, 243, 0.1);
        }
        .course-options label[for="course-quick"]:has(:checked),
        .course-options label[for="course-full"]:has(:checked) {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(74, 128, 243, 0.15);
        }
        .course-options input[type="radio"] {
            margin-right: 12px;
            accent-color: var(--primary-color);
        }

        /* ê³µìš© ë²„íŠ¼ */
        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-family: "Pretendard", sans-serif;
            font-size: 18px;
            font-weight: 600;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 24px;
            width: 100%;
        }
        button:hover:not(:disabled) {
            background-color: #3a68c2;
        }
        button:disabled {
            background-color: #a0b7e8;
            cursor: not-allowed;
        }

        /* 2ë‹¨ê³„: ë¶„ì„ ì¹´ë“œ */
        .chunk-card {
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .chunk-card label {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 8px;
        }
        .chunk-card p.original-text {
            background-color: white;
            padding: 16px;
            border-radius: 4px;
            border: 1px dashed #DDDDDD;
            margin-bottom: 16px;
            line-height: 1.8;
            color: #111;
            white-space: pre-wrap; /* ì›ë³¸ ì¤„ë°”ê¿ˆ ìœ ì§€ */
        }
        .chunk-card textarea.analysis-input {
            min-height: 120px;
            background-color: white;
        }

        /* 3ë‹¨ê³„: í”¼ë“œë°± */
        #feedback-output {
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 32px;
            margin-top: 16px;
            line-height: 1.8;
            white-space: pre-wrap; /* AI í”¼ë“œë°±ì˜ ì¤„ë°”ê¿ˆì„ ìœ ì§€ */
        }
        #feedback-output h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        /* ìœ í‹¸ë¦¬í‹°: ë¡œë”, ìˆ¨ê¹€, ì˜¤ë¥˜ */
        .hidden {
            display: none;
        }

        .loader {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-message {
            display: none;
            color: var(--danger-color);
            background-color: #fce8e6;
            border: 1px solid #f9c6c2;
            padding: 14px 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }
        .error-message.show {
            display: block;
        }

        /* í‘¸í„° */
        footer {
            text-align: center;
            margin-top: 80px;
            padding: 24px 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-bg);
        }
        footer p {
            font-size: 14px;
            color: #888888;
        }
    </style>
</head>
<body>

    <main>
        <div class="container">
            <header>
                <h1>ìª¼ê°œê¸° ë§ˆìŠ¤í„°</h1>
                <p>ë§¤ì¼ í•œ ë¬¸ì¥ì”© ìª¼ê°œê³ , ì»¨í…ì¸  ë§ˆìŠ¤í„°ê°€ ë˜ì„¸ìš”.</p>
            </header>

            <section id="step1-input" class="step-box" aria-labelledby="step1-title">
                <h2 id="step1-title">1. ë¶„ì„í•  í…ìŠ¤íŠ¸ ë° API í‚¤ ì…ë ¥</h2>
                
                <div class="input-group">
                    <label for="api-key-input">Gemini API Key</label>
                    <input type="text" id="api-key-input" placeholder="AIzaSy...ë¡œ ì‹œì‘í•˜ëŠ” API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
                    <p class="api-key-warning">ğŸ’¡ API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©°, ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                </div>
                
                <div class="input-group">
                    <label for="text-input">ë¶„ì„í•  í…ìŠ¤íŠ¸</label>
                    <textarea id="text-input" placeholder="ë¶„ì„í•˜ê³  ì‹¶ì€ ì˜ìƒ ëŒ€ë³¸ì´ë‚˜ ë¸”ë¡œê·¸ ê¸€ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                </div>
                
                <div class="course-options">
                    <label for="course-quick">
                        <input type="radio" id="course-quick" name="course" value="quick" checked>
                        <span>5ê°œ í•µì‹¬ ì˜ë¯¸ ìª¼ê°œê¸° (Quick)</span>
                    </label>
                    <label for="course-full">
                        <input type="radio" id="course-full" name="course" value="full">
                        <span>ì „ì²´ í…ìŠ¤íŠ¸ ìª¼ê°œê¸° (Full Course)</span>
                    </label>
                </div>
                
                <button id="start-split-button">ìª¼ê°œê¸° í›ˆë ¨ ì‹œì‘</button>
                <div id="step1-error" class="error-message" role="alert"></div>
            </section>

            <section id="loader" class="loader hidden" aria-live="polite">
                <div class="spinner"></div>
                <p style="margin-top: 16px; color: var(--subtext-color);">AIê°€ 'ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„'ë¡œ í…ìŠ¤íŠ¸ë¥¼ ìª¼ê°œëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </section>

            <section id="step2-analysis" class="step-box hidden" aria-labelledby="step2-title">
                <h2 id="step2-title">2. ìª¼ê°œì§„ ë‹¨ìœ„ë³„ ì‚¬ê³  ê³¼ì • ë¶„ì„</h2>
                <div id="analysis-container">
                    </div>
                <button id="get-feedback-button">ë¶„ì„ ì™„ë£Œ & AI í”¼ë“œë°± ë°›ê¸°</button>
                <div id="step2-error" class="error-message" role="alert"></div>
            </section>

            <section id="step3-feedback" class="step-box hidden" aria-labelledby="step3-title">
                <h2 id="step3-title">3. AI ì‹œë‹ˆì–´ ë§ˆì¼€í„° ì¢…í•© í”¼ë“œë°±</h2>
                <div id="feedback-output">
                    </div>
            </section>
        </div>
    </main>
    
    <footer>
        <p>Â© 2025 Jjokegi Master. ì´ìƒí•œë§ˆì¼€íŒ… êµ¬ì„±ì› ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>
    </footer>

    <script>
        // ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ë¥¼ DOMContentLoadedë¡œ ê°ì‹¸ ì „ì—­ ìŠ¤ì½”í”„ ì˜¤ì—¼ ë°©ì§€
        document.addEventListener('DOMContentLoaded', () => {

            // 0. API ë° ìƒíƒœ ë³€ìˆ˜
            // ëª¨ë¸ëª…ì„ 'gemini-1.5-flash' (ìµœì‹ )ë¡œ ìˆ˜ì •
            const GEMINI_API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=";
            let userApiKey = ''; // API í‚¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜

            // 1. ìš”ì†Œ ì„ íƒ
            const step1Div = document.getElementById('step1-input');
            const step2Div = document.getElementById('step2-analysis');
            const step3Div = document.getElementById('step3-feedback');
            const loader = document.getElementById('loader');
            
            const apiKeyInput = document.getElementById('api-key-input');
            const textInput = document.getElementById('text-input');
            const splitButton = document.getElementById('start-split-button');
            const feedbackButton = document.getElementById('get-feedback-button');
            
            const analysisContainer = document.getElementById('analysis-container');
            const feedbackOutput = document.getElementById('feedback-output');

            const errorStep1 = document.getElementById('step1-error');
            const errorStep2 = document.getElementById('step2-error');

            // 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            splitButton.addEventListener('click', handleStartSplit);
            feedbackButton.addEventListener('click', handleGetFeedback);

            // 3. UI ì œì–´ í•¨ìˆ˜
            function showLoader(message) {
                step1Div.classList.add('hidden');
                step2Div.classList.add('hidden');
                step3Div.classList.add('hidden');
                loader.querySelector('p').textContent = message;
                loader.classList.remove('hidden');
            }

            function hideLoader() {
                loader.classList.add('hidden');
            }

            function showError(message, step) {
                const errorEl = (step === 1) ? errorStep1 : errorStep2;
                errorEl.textContent = message;
                errorEl.classList.add('show');
            }

            function hideError(step) {
                const errorEl = (step === 1) ? errorStep1 : errorStep2;
                errorEl.textContent = '';
                errorEl.classList.remove('show');
            }

            // 4. Gemini API í˜¸ì¶œ í—¬í¼ (apiKeyë¥¼ ì¸ìë¡œ ë°›ìŒ)
            async function callGemini(promptText, apiKey) {
                const API_URL = GEMINI_API_BASE_URL + apiKey;
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }] }],
                            safetySettings: [
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                            ]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText}. ${errorData.error?.message || 'ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.'}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0].content) {
                        // ì„±ê³µ ì‹œ í…ìŠ¤íŠ¸ ë°˜í™˜
                        return { text: data.candidates[0].content.parts[0].text };
                    }
                    if (data.candidates && data.candidates[0].finishReason === 'SAFETY') {
                        throw new Error("AIê°€ ì•ˆì „ìƒì˜ ì´ìœ ë¡œ ë‹µë³€ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.");
                    }
                    if (data.promptFeedback?.blockReason === 'SAFETY') {
                         throw new Error("AIê°€ ì•ˆì „ìƒì˜ ì´ìœ ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤. (ì…ë ¥ê°’ í™•ì¸)");
                    }
                    
                    throw new Error("AIë¡œë¶€í„° ìœ íš¨í•œ ë‹µë³€ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

                } catch (error) {
                    console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜¤ë¥˜ ê°ì²´ ë°˜í™˜
                    return { error: error.message };
                }
            }
            
            // XSS ë°©ì§€ë¥¼ ìœ„í•œ HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
            function escapeHTML(str) {
                return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            // 5. [1ë‹¨ê³„] í…ìŠ¤íŠ¸ ìª¼ê°œê¸°
            async function handleStartSplit() {
                hideError(1);
                const originalText = textInput.value;
                const apiKey = apiKeyInput.value.trim();

                // ìœ íš¨ì„± ê²€ì‚¬
                if (!apiKey.startsWith('AIzaSy')) {
                    showError("ìœ íš¨í•œ Google AI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. 'AIzaSy'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.", 1);
                    return;
                }
                if (originalText.trim().length < 50) {
                    showError("ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ 50ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.", 1);
                    return;
                }
                
                // API í‚¤ ì €ì¥
                userApiKey = apiKey;
                
                const courseType = document.querySelector('input[name="course"]:checked').value;

                showLoader("AIê°€ 'ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„'ë¡œ í…ìŠ¤íŠ¸ë¥¼ ìª¼ê°œëŠ” ì¤‘ì…ë‹ˆë‹¤...");
                splitButton.disabled = true;

                // í”„ë¡¬í”„íŠ¸ ì •ì˜ (ê¸°ì¡´ê³¼ ë™ì¼)
                let splitPrompt;
                if (courseType === 'quick') {
                    splitPrompt = `
                        ë‹¹ì‹ ì€ ìì²­ì˜ 'ìª¼ê°œê¸° ì´ë¡ 'ì„ ìˆ˜í–‰í•˜ëŠ” AIì…ë‹ˆë‹¤.
                        ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ ë§ˆì¼€íŒ…ì ìœ¼ë¡œ ê°€ì¥ ì¤‘ìš”í•œ 'í•µì‹¬ ì˜ë¯¸ ë‹¨ìœ„' 5ê°œë§Œ ì„ ë³„í•˜ì—¬ ìª¼ê°œì£¼ì„¸ìš”.
                        'ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„'ì—¬ì•¼ í•©ë‹ˆë‹¤. (í•œë‘ ë¬¸ì¥ì˜ ë©ì–´ë¦¬)
                        
                        ê·œì¹™:
                        1. í…ìŠ¤íŠ¸ ì „ì²´ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ 5ê°œë§Œ ê³¨ë¼ì•¼ í•©ë‹ˆë‹¤.
                        2. ì›ë³¸ í…ìŠ¤íŠ¸ì˜ ìˆœì„œì™€ ë‚´ìš©ì„ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
                        3. ê²°ê³¼ëŠ” ì˜¤ì§ JSON ë°°ì—´(Array) í˜•ì‹ìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”. ì˜ˆ: ["ì²« ë²ˆì§¸ í•µì‹¬ ë¬¸ë‹¨.", "ë‘ ë²ˆì§¸ í•µì‹¬ ë¬¸ë‹¨.", ..., "ë‹¤ì„¯ ë²ˆì§¸ í•µì‹¬ ë¬¸ë‹¨."]
                        
                        [ì›ë³¸ í…ìŠ¤íŠ¸]
                        ${originalText}
                    `;
                } else {
                    splitPrompt = `
                        ë‹¹ì‹ ì€ ìì²­ì˜ 'ìª¼ê°œê¸° ì´ë¡ 'ì„ ìˆ˜í–‰í•˜ëŠ” AIì…ë‹ˆë‹¤.
                        ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ 'ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„' (í•œë‘ ë¬¸ì¥ì˜ ë©ì–´ë¦¬)ë¡œ ì „ë¶€ ìª¼ê°œì£¼ì„¸ìš”.
                        ì‚¬ìš©ìê°€ ê° ìª¼ê°œì§„ ë‹¨ìœ„ë³„ë¡œ ìì‹ ì˜ "ì‚¬ê³  ê³¼ì •"ì„ ë¶„ì„í•  ìˆ˜ ìˆë„ë¡ ë‚˜ëˆ ì•¼ í•©ë‹ˆë‹¤.
                        
                        ê·œì¹™:
                        1. ì›ë³¸ í…ìŠ¤íŠ¸ì˜ ìˆœì„œì™€ ë‚´ìš©ì„ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
                        2. ê²°ê³¼ëŠ” ì˜¤ì§ JSON ë°°ì—´(Array) í˜•ì‹ìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”. ì˜ˆ: ["ì²« ë²ˆì§¸ ìª¼ê°œì§„ ë¬¸ë‹¨.", "ë‘ ë²ˆì§¸ ìª¼ê°œì§„ ë¬¸ë‹¨ì…ë‹ˆë‹¤.", "ì„¸ ë²ˆì§¸ì…ë‹ˆë‹¤."]
                        
                        [ì›ë³¸ í…ìŠ¤íŠ¸]
                        ${originalText}
                    `;
                }

                const aiResponse = await callGemini(splitPrompt, userApiKey);

                // API ì˜¤ë¥˜ ì²˜ë¦¬
                if (aiResponse.error) {
                    hideLoader();
                    showError(`ìª¼ê°œê¸° ì‹¤íŒ¨: ${aiResponse.error}`, 1);
                    step1Div.classList.remove('hidden');
                    splitButton.disabled = false;
                    return;
                }

                try {
                    // AI ì‘ë‹µì—ì„œ JSON ë¶€ë¶„ë§Œ ê¹”ë”í•˜ê²Œ ì¶”ì¶œ
                    let jsonString = aiResponse.text;
                    const jsonMatch = aiResponse.text.match(/```json\s*([\s\S]*?)\s*```|(\[.*\])/s);
                    if (jsonMatch) {
                        jsonString = jsonMatch[1] || jsonMatch[2];
                    }
                    
                    const chunks = JSON.parse(jsonString);
                    displayAnalysisInputs(chunks);

                } catch (error) {
                    console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", error, "\nAI ì›ë³¸ ì‘ë‹µ:", aiResponse.text);
                    hideLoader();
                    showError(`ì˜¤ë¥˜: AI ì‘ë‹µ(JSON) íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. AI ì‘ë‹µ: ${aiResponse.text}`, 1);
                    step1Div.classList.remove('hidden');
                    splitButton.disabled = false;
                }
            }

            // 6. [2ë‹¨ê³„] ë¶„ì„ ì…ë ¥ì°½ í‘œì‹œ
            function displayAnalysisInputs(chunks) {
                analysisContainer.innerHTML = ''; // ì´ˆê¸°í™”
                
                chunks.forEach((chunk, index) => {
                    const card = document.createElement('div');
                    card.className = 'chunk-card';
                    
                    // escapeHTML í•¨ìˆ˜ë¡œ XSS ë°©ì§€
                    card.innerHTML = `
                        <label>#${index + 1} ì›ë³¸ ì˜ë¯¸ ë‹¨ìœ„</label>
                        <p class="original-text">${escapeHTML(chunk)}</p>
                        <label for="analysis-input-${index}">ë‚˜ì˜ ì‚¬ê³  ê³¼ì • ë¶„ì„</label>
                        <textarea id="analysis-input-${index}" class="analysis-input" placeholder="ì´ ë¬¸ì¥ì„ ì“´ ì˜ë„, ì‚¬ìš©í•œ ì‹¬ë¦¬í•™ì  ì›ë¦¬, ì œê±°í•˜ë ¤ í•œ ê³ ê°ì˜ ë°˜ë°• ë“±ì„ ìƒì„¸íˆ ì‘ì„±..."></textarea>
                    `;
                    analysisContainer.appendChild(card);
                });
                
                hideLoader();
                step2Div.classList.remove('hidden');
                window.scrollTo(0, 0); // í™”ë©´ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            }

            // 7. [3ë‹¨ê³„] ì‚¬ê³  ê³¼ì • ë¶„ì„ ë° í”¼ë“œë°± ìš”ì²­
            async function handleGetFeedback() {
                hideError(2);
                showLoader("AI ì‹œë‹ˆì–´ ë§ˆì¼€í„°ê°€ ë‹¹ì‹ ì˜ ì‚¬ê³  ê³¼ì •ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");
                feedbackButton.disabled = true;

                const analysisPairs = [];
                const chunkCards = document.querySelectorAll('.chunk-card');
                let analysisMissing = false;

                chunkCards.forEach(card => {
                    const original = card.querySelector('.original-text').innerText;
                    const analysisInput = card.querySelector('.analysis-input');
                    const analysis = analysisInput.value;
                    
                    if (analysis.trim() === "") {
                        analysisMissing = true;
                        analysisInput.style.border = "2px solid var(--danger-color)";
                    } else {
                        analysisInput.style.border = "1px solid var(--border-color)";
                        analysisPairs.push({
                            original_chunk: original,
                            user_analysis: analysis
                        });
                    }
                });

                if (analysisMissing) {
                    hideLoader();
                    showError("ëª¨ë“  'ì‚¬ê³  ê³¼ì • ë¶„ì„' ë€ì„ ì±„ì›Œì£¼ì„¸ìš”.", 2);
                    step2Div.classList.remove('hidden');
                    feedbackButton.disabled = false;
                    return;
                }

                const prompt = `
                    ë‹¹ì‹ ì€ 'ì´ìƒí•œë§ˆì¼€íŒ…'ì˜ ì‹œë‹ˆì–´ ë§ˆì¼€í„°ì´ì 'ìì²­'ì˜ ì² í•™ì„ 100% ì´í•´í•œ AIì…ë‹ˆë‹¤.
                    í•œ êµ¬ì„±ì›ì´ 'ìª¼ê°œê¸° ì´ë¡ 'ì„ í›ˆë ¨í•˜ê¸° ìœ„í•´ í…ìŠ¤íŠ¸ë¥¼ ìª¼ê°œê³ , ê° ë‹¨ìœ„ë³„ë¡œ ìì‹ ì˜ 'ì‚¬ê³  ê³¼ì •(ê¸€ì„ ì“´ ì˜ë„)'ì„ ë¶„ì„í•œ ë‚´ìš©ì„ ì œì¶œí–ˆìŠµë‹ˆë‹¤.
                    
                    ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì´ êµ¬ì„±ì›ì˜ "ì‚¬ê³  ê³¼ì •(user_analysis)"ì„ 'ì´ìƒí•œë§ˆì¼€íŒ…'ì˜ í•µì‹¬ ê°€ì¹˜(ì‹¬ë¦¬í•™, ë³¸ëŠ¥ ë¶„ì„, ë°˜ë°• ì œê±°, ê³ ê° ì„±ê³µ, ê°€ì¹˜ ì¦ëª…, LF8)ì— ë”°ë¼ ë‚ ì¹´ë¡­ê²Œ í‰ê°€í•˜ê³  í”¼ë“œë°±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
                    
                    [êµ¬ì„±ì›ì˜ ë¶„ì„ ë‚´ìš©]
                    ${JSON.stringify(analysisPairs, null, 2)}

                    [í”¼ë“œë°± ì§€ì‹œì‚¬í•­]
                    1. "ì´ìƒí•œë§ˆì¼€íŒ… ì‹œë‹ˆì–´ ë§ˆì¼€í„°"ì˜ ì „ë¬¸ì ì¸ í†¤ìœ¼ë¡œ í”¼ë“œë°±í•˜ì„¸ìš”.
                    2. ì§€ì›ìì˜ 'ì‚¬ê³  ê³¼ì •'ì´ ì–¼ë§ˆë‚˜ ê¹Šì´ ìˆëŠ”ì§€, ê³ ê°ì˜ ì‹¬ë¦¬ë¥¼ ì •í™•íˆ ê¿°ëš«ì—ˆëŠ”ì§€ í‰ê°€í•˜ì„¸ìš”.
                    3. **[ì˜í•œ ì  (Good Points)]** ê³¼ **[ê°œì„ í•  ì  (Areas for Improvement)]** ì„ ëª…í™•í•œ ë¶ˆë¦¿ í¬ì¸íŠ¸ë¡œ ë‚˜ëˆ ì„œ ì„¤ëª…í•˜ì„¸ìš”.
                    4. ìµœì¢…ì ìœ¼ë¡œ ì´ 'ì‚¬ê³  ê³¼ì •'ì˜ ì™„ì„±ë„ë¥¼ **[ìª¼ê°œê¸° ì‹¤ë ¥ (100ì  ë§Œì )]** ìœ¼ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”.
                    5. ì´ í”¼ë“œë°±ì€ êµ¬ì„±ì›ì˜ ì„±ì¥ì„ ë•ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ë‚ ì¹´ë¡­ì§€ë§Œ ê±´ì„¤ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. (Markdown í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ)
                `;

                const aiFeedback = await callGemini(prompt, userApiKey);

                if (aiFeedback.error) {
                    hideLoader();
                    showError(`í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨: ${aiFeedback.error}`, 2);
                    step2Div.classList.remove('hidden');
                    feedbackButton.disabled = false;
                    return;
                }
                
                // (ì£¼ì˜) AIì˜ ì‘ë‹µì€ Markdownì„ í¬í•¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
                // ë‹¨ìˆœ textê°€ ì•„ë‹Œ HTMLë¡œ ë Œë”ë§í•´ì•¼ í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ <br>ë¡œ ë³€í™˜í•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” Markdown íŒŒì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬(marked.js ë“±) ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                const feedbackHtml = aiFeedback.text
                    .replace(/</g, "&lt;").replace(/>/g, "&gt;") // 1. ê¸°ë³¸ HTML ì´ìŠ¤ì¼€ì´í”„
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // 2. **ë³¼ë“œ**
                    .replace(/\*(.*?)\*/g, '<em>$1</em>') // 3. *ì´íƒ¤ë¦­*
                    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>') // 4. [ë§í¬](url)
                    .replace(/\n/g, '<br>'); // 5. ì¤„ë°”ê¿ˆ

                feedbackOutput.innerHTML = `<h3>AI ì‹œë‹ˆì–´ ë§ˆì¼€í„° í”¼ë“œë°±</h3>${feedbackHtml}`;
                hideLoader();
                step3Div.classList.remove('hidden');
                feedbackButton.disabled = false;
                window.scrollTo(0, 0); // í™”ë©´ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            }

        }); // End of DOMContentLoaded
    </script>
</body>
</html>