<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìª¼ê°œê¸° ë§ˆìŠ¤í„° v1.2 (ì„±ì¥ ë¦¬í¬íŠ¸)</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4A80F3;
            --text-color: #333333;
            --light-bg-color: #f9f9f9;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --warning-color: #fd7e14; /* ì£¼í™©ìƒ‰ ê³„ì—´ */
            --danger-color: #dc3545; /* ë¹¨ê°„ìƒ‰ ê³„ì—´ */
            --white-color: #FFFFFF;
            --font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--white-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

       .container {
            width: 100%;
            max-width: 800px;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 36px;
            font-weight: 800;
            margin: 0;
            color: var(--primary-color);
        }

        header p {
            font-size: 18px;
            color: #666;
            margin-top: 8px;
        }

        /* --- [NEW] ì˜¤ë¥˜ ë°°ë„ˆ ìŠ¤íƒ€ì¼ --- */
        #error-banner {
            background-color: var(--danger-color);
            color: var(--white-color);
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        #error-message {
            font-weight: 600;
            margin: 0;
        }
        #error-close {
            background: none;
            border: none;
            color: var(--white-color);
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            padding: 0 8px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        #error-close:hover {
            opacity: 1;
        }
        /* --- [END] ì˜¤ë¥˜ ë°°ë„ˆ ìŠ¤íƒ€ì¼ --- */


       .main-card {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        /* ì…ë ¥ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        #input-section h2, #analysis-section h2, #feedback-report-section h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }
         #input-section h2:first-of-type { margin-top: 0; }


        #text-input {
            width: 100%;
            height: 200px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: var(--font-family);
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 8px; /* ì¹´ìš´í„° ê³µê°„ */
        }

        /* --- [NEW] ê¸€ì ìˆ˜ ì¹´ìš´í„° ìŠ¤íƒ€ì¼ --- */
        #char-counter {
            text-align: right;
            font-size: 14px;
            font-weight: 500;
            color: var(--danger-color); /* ê¸°ë³¸ê°’ (ë¶€ì¡±) */
        }
        #char-counter.sufficient {
            color: var(--success-color); /* ì¶©ì¡± ì‹œ */
            font-weight: 600;
        }
        /* --- [END] ê¸€ì ìˆ˜ ì¹´ìš´í„° ìŠ¤íƒ€ì¼ --- */


       .course-options {
            margin-top: 24px;
            display: flex;
            gap: 16px;
        }

       .course-option {
            flex: 1;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

       .course-option:hover,.course-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 128, 243, 0.2);
        }

       .course-option h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

       .course-option p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

       .btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin-top: 24px;
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-sizing: border-box; /* ë„ˆë¹„ ê³„ì‚°ì— íŒ¨ë”© í¬í•¨ */
        }
       .btn-secondary { /* ìƒˆë¡œìš´ í›ˆë ¨ ì‹œì‘ ë²„íŠ¼ */
            background-color: #6c757d; /* íšŒìƒ‰ ê³„ì—´ */
            margin-top: 32px;
       }
       .btn-secondary:hover {
             background-color: #5a6268;
       }

       .btn:hover {
            background-color: #3a6cc7;
        }

       .btn:disabled {
            background-color: #a0b9e8;
            cursor: not-allowed;
        }

        /* ë¶„ì„ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        #analysis-section {
            /* display: none; â¬…ï¸ ì´ ì½”ë“œë¥¼ ì‚­ì œí–ˆìŒ. */
        }
         #analysis-section h2 { text-align: center; margin-bottom: 12px; } /* ë§ˆì§„ ì¡°ì • */

        /* --- [NEW] ì§„í–‰ë¥  í‘œì‹œê¸° ìŠ¤íƒ€ì¼ --- */
        #progress-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin: -8px 0 24px 0; /* h2ì™€ ì¹´ë“œ ì‚¬ì´ */
        }
        /* --- [END] ì§„í–‰ë¥  í‘œì‹œê¸° ìŠ¤íƒ€ì¼ --- */


       .chunk-card {
            background: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 24px;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* ì¢Œìš° ë¶„í•  ë ˆì´ì•„ì›ƒ */
            gap: 24px;
        }

       .original-text-container {
            background-color: var(--light-bg-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

       .original-text-container h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            display: flex; align-items: center; gap: 6px;
       }
       .original-text-container h4::before { /* ì•„ì´ì½˜ ì˜ˆì‹œ */
             content: 'ğŸ“„';
       }


        p.original-text {
            font-size: 16px;
            line-height: 1.7;
            margin: 0;
            word-break: keep-all;
        }

       .analysis-input-container h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
             display: flex; align-items: center; gap: 6px;
       }
        .analysis-input-container h4::before { /* ì•„ì´ì½˜ ì˜ˆì‹œ */
             content: 'âœï¸';
        }


        textarea.analysis-input {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: var(--font-family);
            font-size: 15px;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s; /* í¬ì»¤ìŠ¤ íš¨ê³¼ */
        }
        textarea.analysis-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 128, 243, 0.2);
            outline: none;
        }
        /* ì…ë ¥ ëˆ„ë½ ì‹œ ìŠ¤íƒ€ì¼ (JSë¡œ ì œì–´) */
        textarea.analysis-input.invalid {
            border: 1px solid var(--danger-color);
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
        }


        /* ì„±ì¥ ë¦¬í¬íŠ¸ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        #feedback-report-section {
            width: 100%;
            max-width: 800px; /* containerì™€ ë™ì¼ ë„ˆë¹„ */
            padding: 0; /* ë‚´ë¶€ì—ì„œ íŒ¨ë”© ê´€ë¦¬ */
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
        }

        .report-header {
            text-align: center;
            padding: 32px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 0; /* main-cardì™€ ë¶™ì´ê¸° */
        }
        .report-header h2 {
            font-size: 28px;
            margin: 0 0 8px 0;
            color: var(--primary-color);
            border-bottom: none; /* í—¤ë” ì œëª©ì—ëŠ” ë°‘ì¤„ ì œê±° */
        }


        #feedback-score-container {
            text-align: center;
        }

        #feedback-score {
            font-size: 96px; /* ë” í¬ê²Œ */
            font-weight: 900;
            margin: 0; /* ìœ„ì•„ë˜ ë§ˆì§„ ì œê±° */
            line-height: 1; /* ì¤„ ê°„ê²© íƒ€ì´íŠ¸í•˜ê²Œ */
        }

       /* ì ìˆ˜ë³„ ìƒ‰ìƒ */
       .score-s { color: var(--success-color); } /* 85+ */
       .score-a { color: var(--primary-color); } /* 60-84 */
       .score-b { color: var(--warning-color); } /* 40-59 */
       .score-c { color: var(--danger-color); }  /* 0-39 */


        #feedback-summary {
            font-size: 22px; /* ì•½ê°„ í¬ê²Œ */
            font-weight: 600;
            margin-top: 8px; /* ì ìˆ˜ì™€ ì•½ê°„ ê°„ê²© */
            margin-bottom: 32px;
            color: #555;
        }

        /* ë ˆì´ë” ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        #chart-container {
             width: 100%;
             max-width: 400px; /* ì°¨íŠ¸ í¬ê¸° ì¡°ì ˆ */
             margin: 0 auto 32px auto; /* ì¤‘ì•™ ì •ë ¬ ë° ì•„ë˜ ê°„ê²© */
             padding: 24px;
             background-color: var(--light-bg-color);
             border-radius: 8px;
        }

       .feedback-details {
            display: grid; /* Flex ëŒ€ì‹  Grid ì‚¬ìš© */
            grid-template-columns: 1fr 1fr; /* ì¢Œìš° 2ë‹¨ */
            gap: 24px;
            text-align: left;
            margin-bottom: 32px;
        }

       .feedback-panel {
            /* flex: 1; ì œê±° */
            background-color: var(--light-bg-color);
            border-radius: 8px;
            padding: 24px; /* íŒ¨ë”© ì¦ê°€ */
        }

       .feedback-panel h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700; /* ì œëª© ê°•ì¡° */
       }

        #good-points-panel h3 { color: var(--success-color); }
        #improvement-points-panel h3 { color: var(--warning-color); }

       .feedback-panel ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

       .feedback-panel li {
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.7;
            padding-left: 20px; /* ì•„ì´ì½˜ ê³µê°„ */
            position: relative;
       }
        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì•ì— ì•„ì´ì½˜ ì¶”ê°€ */
       #good-points-panel li::before {
           content: 'ğŸ‘';
           position: absolute; left: 0;
       }
        #improvement-points-panel li::before {
           content: 'ğŸ“ˆ';
           position: absolute; left: 0;
       }

        /* ì•¡ì…˜ í”Œëœ ë° ì…€í”„ ì½”ì¹­ */
        .action-plan-section, .self-coaching-section {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
         .action-plan-section h3, .self-coaching-section h3 {
             font-size: 18px;
             font-weight: 700;
             margin: 0 0 16px 0;
             display: flex; align-items: center; gap: 8px;
             color: var(--primary-color);
         }
        .action-plan-section h3::before { content: 'ğŸ¯'; }
        .self-coaching-section h3::before { content: 'ğŸ¤”'; }

         .action-plan-section p, .self-coaching-section p {
             font-size: 16px;
             line-height: 1.7;
             margin: 0;
             color: #555;
         }
         .self-coaching-section ul {
            list-style-type: none; padding: 0; margin-top: 12px;
         }
         .self-coaching-section li {
             margin-bottom: 8px; font-size: 15px; color: #555;
             padding-left: 20px; position: relative;
         }
         .self-coaching-section li::before {
              content: 'â“'; position: absolute; left: 0;
         }


       /* --- [DELETED] ìŠ¤ì¼ˆë ˆí†¤ ë¡œë” ìŠ¤íƒ€ì¼ --- */
       /*
        .skeleton-box { ... }
        #analysis-skeleton .chunk-card-skeleton { ... }
        #feedback-skeleton .score-skeleton { ... }
        ...
        */


        /* --- [NEW] ë™ì  ë¡œë” ìŠ¤íƒ€ì¼ --- */
        #dynamic-loader {
            text-align: center;
            padding: 48px;
            align-items: center;
            justify-content: center;
            /* display: flex;ê°€ JSì˜ .hiddenì„ ì´ê¸°ë¯€ë¡œ, JSë¡œ ì œì–´í•©ë‹ˆë‹¤. */
            flex-direction: column;
            gap: 24px;
        }
        .spinner {
            border: 6px solid #f3f3f3; /* Light grey */
            border-top: 6px solid var(--primary-color); /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        #loader-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }
        /* --- [END] ë™ì  ë¡œë” ìŠ¤íƒ€ì¼ --- */


        footer {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: #999;
            margin-top: 40px; /* ë¦¬í¬íŠ¸ì™€ í‘¸í„° ê°„ê²© */
        }

        .hidden { display: none !important; } /* í™•ì‹¤íˆ ìˆ¨ê¹€ */

        /* --- [MODIFIED] spin ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ --- */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes skeleton-shine {
            0% { left: -150%; }
            100% { left: 150%; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
           .container { padding: 20px 15px; }
           header h1 { font-size: 28px; }
           header p { font-size: 16px; }
           .main-card, .chunk-card, .feedback-panel, .action-plan-section, .self-coaching-section { padding: 20px; }
           #text-input { height: 150px; }
           .course-options {
               flex-direction: column; /* 3ê°œì—¬ë„ ì„¸ë¡œ ì •ë ¬ */
           }
           .chunk-card {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ì •ë ¬ */
           }
           #feedback-score { font-size: 72px; }
           #feedback-summary { font-size: 18px; }
           .feedback-details {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ì •ë ¬ */
           }
           /* --- [DELETED] ìŠ¤ì¼ˆë ˆí†¤ ëª¨ë°”ì¼ --- */
           /*
           #feedback-skeleton .details-skeleton {
                grid-template-columns: 1fr;
           }
           */
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ìª¼ê°œê¸° ë§ˆìŠ¤í„°</h1>
            <p>ë§¤ì¼ í•œ ë¬¸ì¥ì”© ìª¼ê°œê³ , ì»¨í…ì¸  ë§ˆìŠ¤í„°ê°€ ë˜ì„¸ìš”.</p>
        </header>

        <div id="error-banner" class="hidden">
            <p id="error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <button id="error-close" type="button" aria-label="ë‹«ê¸°">&times;</button>
        </div>

        <div id="dynamic-loader" class="main-card hidden">
            <div class="spinner"></div>
            <p id="loader-text">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>


        <div class="main-card" id="input-section">
            <h2>1. ë¶„ì„í•  í…ìŠ¤íŠ¸ ì…ë ¥</h2>
            <textarea id="text-input" placeholder="ë¶„ì„í•˜ê³  ì‹¶ì€ ë¸”ë¡œê·¸ ê¸€, ì˜ìƒ ëŒ€ë³¸, ì¹´í”¼ ë“±ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (50ì ì´ìƒ)"></textarea>
            <div id="char-counter">0 / 50ì</div>

            <h2 style="margin-top: 32px;">2. í›ˆë ¨ ì½”ìŠ¤ ì„ íƒ</h2>
            <div class="course-options">
                <div class="course-option" data-course="quick">
                    <h3>Quick Course</h3>
                    <p>í•µì‹¬ ì˜ë¯¸ 5ê°œ ìª¼ê°œê¸°<br>(ì „ëµì  í•µì‹¬ ì ê²€)</p>
                </div>
                <div class="course-option" data-course="medium">
                    <h3>Medium Course</h3>
                    <p>ì£¼ìš” ì˜ë¯¸ 10ê°œ ìª¼ê°œê¸°<br>(í•µì‹¬ ë…¼ë¦¬ ì§‘ì¤‘ í›ˆë ¨)</p>
                </div>
                <div class="course-option" data-course="full">
                    <h3>Full Course</h3>
                    <p>ì „ì²´ í…ìŠ¤íŠ¸ ìª¼ê°œê¸°<br>(ì‹¬ì¸µ ì§‘ì¤‘ í›ˆë ¨)</p>
                </div>
            </div>

            <button id="start-split-button" class="btn" disabled>ìª¼ê°œê¸° í›ˆë ¨ ì‹œì‘</button>
        </div>

        <div id="analysis-section" class="hidden">
            <h2 style="text-align: center; margin-bottom: 12px;">3. ì‚¬ê³  ê³¼ì • ë¶„ì„</h2>
            <p id="progress-indicator">0 / 0 í•­ëª© ë¶„ì„ ì™„ë£Œ</p>
            <div id="analysis-inputs">
                </div>
            <button id="get-feedback-button" class="btn">ë¶„ì„ ì™„ë£Œ & ì„±ì¥ ë¦¬í¬íŠ¸ ë³´ê¸°</button>
        </div>

        <div id="feedback-report-section" class="hidden">
            <div class="main-card report-header">
                <h2>ğŸ“Š ì„±ì¥ ë¦¬í¬íŠ¸</h2>
                 <div id="feedback-score-container">
                    <p style="font-size: 18px; font-weight: 600; color: #555; margin: 0;">ë‹¹ì‹ ì˜ ìª¼ê°œê¸° ì‹¤ë ¥ì€...</p>
                    <div id="feedback-score"></div>
                    <p id="feedback-summary"></p>
                 </div>
            </div>

             <div class="main-card">
                 <h2>ğŸ“ˆ 4ëŒ€ ê¸°ì¤€ í‰ê°€</h2>
                 <div id="chart-container">
                     <canvas id="feedback-radar-chart"></canvas>
                 </div>

                 <div class="feedback-details">
                    <div class="feedback-panel" id="good-points-panel">
                        <h3>ì˜í•œ ì </h3>
                        <ul id="good-points-list"></ul>
                    </div>
                    <div class="feedback-panel" id="improvement-points-panel">
                        <h3>ê°œì„ í•  ì </h3>
                        <ul id="improvement-points-list"></ul>
                    </div>
                 </div>
            </div>

             <div class="action-plan-section">
                 <h3>ë‹¤ìŒ í›ˆë ¨ ëª©í‘œ ì œì•ˆ</h3>
                 <p id="action-plan-text"></p>
             </div>

             <div class="self-coaching-section">
                 <h3>ìŠ¤ìŠ¤ë¡œì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”</h3>
                 <ul>
                    <li>ì˜¤ëŠ˜ ë°›ì€ í”¼ë“œë°± ì¤‘ ê°€ì¥ ê°œì„ ì´ ì‹œê¸‰í•œ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€?</li>
                    <li>ì´ í”¼ë“œë°±ì„ ë‚´ì¼ ì‘ì„±í•  OOO ì½˜í…ì¸ ì— ì–´ë–»ê²Œ ì ìš©í•  ìˆ˜ ìˆì„ê¹Œ?</li>
                    <li>ìª¼ê°œê¸° ì‹¤ë ¥ í–¥ìƒì„ ìœ„í•´ ì¶”ê°€ì ìœ¼ë¡œ ì–´ë–¤ ë…¸ë ¥ì„ í•  ìˆ˜ ìˆì„ê¹Œ?</li>
                 </ul>
             </div>

             <button id="reset-button" class="btn btn-secondary">ìƒˆë¡œìš´ í›ˆë ¨ ì‹œì‘</button>
        </div>

        </div> <footer>
        <p>Â© 2025 Jjokegi Master. ì´ìƒí•œë§ˆì¼€íŒ… êµ¬ì„±ì› ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>
    </footer>

    <script>
        // --- [START] REAL AI CONFIGURATION ---
        const GEMINI_API_KEY = "AIzaSyCVTLte-n_F-83vTq3P1Fc16NzGXdKaIYI";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        // --- [END] REAL AI CONFIGURATION ---


        // --- S-Class AI Prompts ---
        // --- [START] ìˆ˜ì •ëœ ë¶€ë¶„ : ìª¼ê°œê¸° ìˆœì„œ ì˜¤ë¥˜ ìˆ˜ì • ---
        const SPLIT_PROMPT = (text, mode) => {
            const coreInstruction = `
                You are an expert in Jacheong's 'Jjokegi Theory'. Your task is to analyze the *entire* text provided below to find the 'Minimum Viable Meaning Units' (ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„) that a master marketer would identify.
                A 'Minimum Viable Meaning Unit' is an individual claim, psychological hook, setup/payoff pair, problem-solution statement, or distinct persuasive argument. A single sentence may contain multiple meaning units.
            `;

            const modeInstruction = mode === 'quick'
               ? "After analyzing the *entire* text, extract *only* the 5 *most strategically important* meaning units from anywhere in the text. Do not just take the first 5."
               : (mode === 'medium'
                    ? "After analyzing the *entire* text, extract *only* the 10 *most strategically important* meaning units from anywhere in the text. Do not just take the first 10."
                    : "Deconstruct the *entire* text into *all* its meaning units, in the order they appear.");

            const outputInstruction = "Your output MUST be a JSON array of strings, with no other text, commentary, or explanation.";

            return `${coreInstruction}\n\n${modeInstruction}\n\n${outputInstruction}\n\nText to analyze:\n"""${text}"""\n\nOutput only the JSON array.`;
        };
        // --- [END] ìˆ˜ì •ëœ ë¶€ë¶„ ---

        const FEEDBACK_PROMPT = (userAnalyses) => {
            // ***** KOREAN FEEDBACK & ENHANCED JSON MODIFICATION *****
            return `
                You are an S-Class Senior Marketer at 'Isanghan Marketing'. You have completely internalized the philosophies of Jacheong. Your feedback must be mercilessly sharp, logical, and strategic, but ultimately constructive, aimed at fostering rapid growth in a junior marketer. Do not be polite or vague. Be direct and analytical. **Crucially, all feedback text (good_points, improvement_points, action_plan) MUST be written in KOREAN and MUST NOT contain any markdown formatting (\`**\`, \`\`\` etc.). Use plain text only.**

                Your sole mission is to evaluate the user's submitted 'thought process' for each text chunk based on the quality and depth of their strategic reasoning.

                **[START OF MODIFICATION]**
                **íŠ¹íˆ ë‹¤ìŒ ê¸°ì¤€ì„ ì¤‘ì ì ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”:**

                1.  **[ë³¸ëŠ¥ ë¶„ì„]** ì‚¬ìš©ìì˜ ë¶„ì„ì´ ê³ ê°ì˜ í•µì‹¬ì ì¸ 'ë³¸ëŠ¥(ë‘ë ¤ì›€, ìš•ë§, LF8)'ì„ ì •í™•íˆ í¬ì°©í–ˆëŠ”ê°€?
                2.  **[ë°˜ë°• ì œê±°]** í•´ë‹¹ ë¬¸ì¥ì´ ê³ ê°ì˜ ì˜ˆìƒ 'ë°˜ë°•'ì„ ì–¼ë§ˆë‚˜ íš¨ê³¼ì ìœ¼ë¡œ ì„ ì œ ì œê±°í•˜ê±°ë‚˜ í•´ì†Œí•˜ëŠ” ë…¼ë¦¬ë¥¼ ê°€ì¡ŒëŠ”ê°€?
                3.  **[ê³ ê° ì„±ê³µ ê¸°ì—¬ë„]** ì‚¬ìš©ìì˜ ë¶„ì„ì´, í•´ë‹¹ ë¬¸ì¥ì´ **ê¶ê·¹ì ì¸ 'ê³ ê° ì„±ê³µ'(ì˜ˆ: ì‹ ë¢° í˜•ì„±, ë‹¤ìŒ ë‹¨ê³„ë¡œì˜ í–‰ë™ ìœ ë„, êµ¬ë§¤ ê²°ì • ì´‰ì§„ ë“±)**ì— ì–´ë–»ê²Œ ê¸°ì—¬í•˜ëŠ”ì§€ë¥¼ ëª…í™•íˆ ì„¤ëª…í•˜ê³  ìˆëŠ”ê°€? (ë‹¨ìˆœíˆ ê¸°ìˆ ì  ë¶„ì„ì— ê·¸ì¹˜ì§€ ì•Šê³ , ìµœì¢… ëª©í‘œì™€ì˜ ì—°ê²°ì„±ì„ í‰ê°€)
                4.  **[ì‹¬ë¦¬í•™/ê°€ì¹˜ ì¦ëª…]** ì‚¬ìš©ëœ ì‹¬ë¦¬í•™ì  ì›ë¦¬ë‚˜ ê°€ì¹˜ ì¦ëª… ë°©ì‹ì´ ëª…í™•í•˜ê³  ì„¤ë“ë ¥ ìˆëŠ”ê°€?
                **[END OF MODIFICATION]**

                Provide your response in a strict JSON format with five keys:
                1.  "score": An integer from 0 to 100 representing the overall quality of the user's thought process.
                2.  "criteria_scores": An object containing integer scores (0-100) for EACH of the 4 criteria above (keys: "instinct", "rebuttal", "psychology", "customer_success"). Base these scores on your evaluation.
                3.  "good_points": An array of strings detailing what the user did well **in KOREAN plain text**, referencing the criteria.
                4.  "improvement_points": An array of strings with actionable advice on what to improve **in KOREAN plain text**, referencing the criteria.
                5.  "action_plan": A single string containing a concise (1-2 sentences) recommended next training goal **in KOREAN plain text**, based on the biggest area for improvement.

                Do not add any other text, commentary, or markdown formatting. Just the raw JSON object.

                User's Analyses to evaluate:
                ${JSON.stringify(userAnalyses, null, 2)}
            `;
            // ***** END OF MODIFICATION *****
        };

        // --- DOM Elements ---
        const inputSection = document.getElementById('input-section');
        const analysisSection = document.getElementById('analysis-section');
        const feedbackReportSection = document.getElementById('feedback-report-section');
        // --- [DELETED] loader ---
        // const loader = document.getElementById('loader');

        // --- [MODIFIED] ìŠ¤ì¼ˆë ˆí†¤ -> ë™ì  ë¡œë” ë° ì˜¤ë¥˜ ë°°ë„ˆ ---
        const errorBanner = document.getElementById('error-banner');
        const errorMessage = document.getElementById('error-message');
        const errorClose = document.getElementById('error-close');
        // --- [DELETED] analysisSkeleton, feedbackSkeleton ---
        // const analysisSkeleton = document.getElementById('analysis-skeleton');
        // const feedbackSkeleton = document.getElementById('feedback-skeleton');
        const dynamicLoader = document.getElementById('dynamic-loader'); // [NEW]
        const loaderText = document.getElementById('loader-text'); // [NEW]

        const textInput = document.getElementById('text-input');
        const charCounter = document.getElementById('char-counter'); // [NEW]
        const courseOptionsContainer = document.querySelector('.course-options');
        const courseOptions = document.querySelectorAll('.course-option');
        const startSplitButton = document.getElementById('start-split-button');
        const analysisInputsContainer = document.getElementById('analysis-inputs');
        const progressIndicator = document.getElementById('progress-indicator'); // [NEW]
        const getFeedbackButton = document.getElementById('get-feedback-button');
        const resetButton = document.getElementById('reset-button'); // New reset button

        // Feedback Report Elements
        const feedbackScoreEl = document.getElementById('feedback-score');
        const feedbackSummaryEl = document.getElementById('feedback-summary');
        const feedbackChartCanvas = document.getElementById('feedback-radar-chart');
        const goodPointsList = document.getElementById('good-points-list');
        const improvementPointsList = document.getElementById('improvement-points-list');
        const actionPlanText = document.getElementById('action-plan-text');

        let selectedCourse = null;
        let originalChunks = [];
        let feedbackChart = null; // To hold the chart instance
        let loaderInterval = null; // [NEW] ë¡œë” í…ìŠ¤íŠ¸ ìˆœí™˜ìš©

        // --- Event Listeners ---
        textInput.addEventListener('input', () => {
            updateButtonState();
            updateCharCounter(); // [NEW]
        });
        errorClose.addEventListener('click', () => errorBanner.classList.add('hidden')); // [NEW]
        // [NEW] ë¶„ì„ ì…ë ¥ì°½ì— ëŒ€í•œ ì´ë²¤íŠ¸ ìœ„ì„
        analysisInputsContainer.addEventListener('input', updateProgressIndicator);

        courseOptions.forEach(option => {
            option.addEventListener('click', () => {
                courseOptions.forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedCourse = option.dataset.course;
                updateButtonState();
            });
        });

        startSplitButton.addEventListener('click', handleStartSplit);
        getFeedbackButton.addEventListener('click', handleGetFeedback);
        resetButton.addEventListener('click', resetUI); // Add listener for reset button


        // --- Core Functions ---

        // --- [NEW] showError í•¨ìˆ˜ ---
        function showError(message) {
            errorMessage.textContent = safeHtml(message);
            errorBanner.classList.remove('hidden');
            window.scrollTo(0, 0); // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        }

        // --- [NEW] updateCharCounter í•¨ìˆ˜ ---
        function updateCharCounter() {
            const length = textInput.value.length;
            charCounter.textContent = `${length} / 50ì`;
            if (length >= 50) {
                charCounter.classList.add('sufficient');
            } else {
                charCounter.classList.remove('sufficient');
            }
        }

        // --- [NEW] updateProgressIndicator í•¨ìˆ˜ ---
        function updateProgressIndicator() {
            const allInputs = analysisInputsContainer.querySelectorAll('.analysis-input');
            const total = allInputs.length;
            if (total === 0) return;

            let completed = 0;
            allInputs.forEach(input => {
                if (input.value.trim().length > 0) {
                    completed++;
                }
            });
            progressIndicator.textContent = `${completed} / ${total} í•­ëª© ë¶„ì„ ì™„ë£Œ`;
        }


        function updateButtonState() {
            startSplitButton.disabled = !(textInput.value.trim().length >= 50 && selectedCourse); // 50ì ì´ìƒ ì¡°ê±´
        }

        // --- [NEW] ë™ì  ë¡œë” ì œì–´ í•¨ìˆ˜ ---
        function showDynamicLoader(messages = ["ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."]) {
            let messageIndex = 0;
            loaderText.textContent = messages[messageIndex];

            // Clear any existing interval
            if (loaderInterval) {
                clearInterval(loaderInterval);
            }

            // Cycle through messages
            loaderInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                loaderText.textContent = messages[messageIndex];
            }, 2500); // 2.5ì´ˆë§ˆë‹¤ í…ìŠ¤íŠ¸ ë³€ê²½

            dynamicLoader.classList.remove('hidden');
            // 'main-card'ì— 'flex'ê°€ ì—†ìœ¼ë¯€ë¡œ display:flex ëŒ€ì‹  remove('hidden')ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            // #dynamic-loader CSSì— display:flexê°€ ì—†ìŒì„ í™•ì¸.
            // ì•„, .main-cardì— display:flexê°€ ì—†êµ°ìš”. .hiddenë§Œ ì œì–´í•˜ë©´ ë©ë‹ˆë‹¤.
        }

        function hideDynamicLoader() {
            if (loaderInterval) {
                clearInterval(loaderInterval);
            }
            loaderInterval = null;
            dynamicLoader.classList.add('hidden');
        }
        // --- [END] ë™ì  ë¡œë” ì œì–´ í•¨ìˆ˜ ---


        async function handleStartSplit() {
            const text = textInput.value.trim();
             // ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
            if (text.length < 50) {
                 showError("ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ 50ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”."); // [MODIFIED]
                 return;
            }
            if (!selectedCourse) {
                showError("í›ˆë ¨ ì½”ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); // [MODIFIED]
                return;
            }

            startSplitButton.disabled = true;
            startSplitButton.textContent = 'AIê°€ ìª¼ê°œëŠ” ì¤‘...';
            // --- [MODIFIED] ë¡œë” ë¡œì§ ë³€ê²½ ---
            inputSection.classList.add('hidden'); // ì…ë ¥ ì„¹ì…˜ ìˆ¨ê¹€
            // analysisSkeleton.classList.remove('hidden'); // [DELETED]
            const splitMessages = [
                "AIê°€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",
                "ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„ë¡œ ìª¼ê°œê³  ìˆìŠµë‹ˆë‹¤...",
                "í•µì‹¬ ì „ëµì„ íŒŒì•… ì¤‘ì…ë‹ˆë‹¤..."
            ];
            showDynamicLoader(splitMessages); // [NEW]
            errorBanner.classList.add('hidden'); // ê¸°ì¡´ ì˜¤ë¥˜ ìˆ¨ê¹€

            try {
                const chunks = await callGeminiApi(SPLIT_PROMPT(text, selectedCourse));
                originalChunks = chunks;
                displayAnalysisInputs(chunks);
                analysisSection.classList.remove('hidden'); // ë¶„ì„ ì„¹ì…˜ í‘œì‹œ
            } catch (error) {
                console.error('Error splitting text:', error);
                showError(`í…ìŠ¤íŠ¸ë¥¼ ìª¼ê°œëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); // [MODIFIED]
                inputSection.classList.remove('hidden'); // ì˜¤ë¥˜ ì‹œ ì…ë ¥ ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
            } finally {
                startSplitButton.disabled = false;
                startSplitButton.textContent = 'ìª¼ê°œê¸° í›ˆë ¨ ì‹œì‘';
                // --- [MODIFIED] ë¡œë” ë¡œì§ ë³€ê²½ ---
                // analysisSkeleton.classList.add('hidden'); // [DELETED]
                hideDynamicLoader(); // [NEW]
            }
        }

        function displayAnalysisInputs(chunks) {
            analysisInputsContainer.innerHTML = '';
            chunks.forEach((chunk, index) => {
                const card = document.createElement('div');
                card.className = 'chunk-card';
                const safeChunk = chunk.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                card.innerHTML = `
                    <div class="original-text-container">
                        <h4>#${index + 1} ì›ë³¸ ì˜ë¯¸ ë‹¨ìœ„</h4>
                        <p class="original-text">${safeChunk}</p>
                    </div>
                    <div class="analysis-input-container">
                        <h4>ë‚˜ì˜ ì‚¬ê³  ê³¼ì • ë¶„ì„</h4>
                        <textarea class="analysis-input" data-index="${index}" placeholder="ì´ ë¬¸ì¥ì„ ì“´ ì˜ë„ëŠ” ë¬´ì—‡ì¸ê°€?\nê³ ê°ì˜ ì–´ë–¤ ë°˜ë°•ì„ ì œê±°í•˜ë ¤ í–ˆëŠ”ê°€?\nì–´ë–¤ ì‹¬ë¦¬í•™ì  ì›ë¦¬ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?"></textarea>
                    </div>
                `;
                analysisInputsContainer.appendChild(card);
            });
            updateProgressIndicator(); // [NEW] ì´ˆê¸° ì§„í–‰ë¥  ì„¤ì • (0 / N)
        }

        async function handleGetFeedback() {
            const analysisTextareas = document.querySelectorAll('.analysis-input');
            const userAnalyses = [];
            let allFilled = true;

            analysisTextareas.forEach(textarea => {
                const analysisText = textarea.value.trim();
                textarea.classList.remove('invalid'); // [NEW] ì´ˆê¸°í™”
                if (!analysisText) {
                    allFilled = false;
                    textarea.classList.add('invalid'); // [NEW] ë¹¨ê°„ í…Œë‘ë¦¬
                }
                userAnalyses.push({
                    original_chunk: originalChunks[textarea.dataset.index],
                    user_analysis: analysisText
                });
            });

            if (!allFilled) {
                showError('ëª¨ë“  ì‚¬ê³  ê³¼ì • ë¶„ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ëˆ„ë½ëœ í•­ëª©ì´ í‘œì‹œë©ë‹ˆë‹¤.'); // [MODIFIED]
                return;
            }

            getFeedbackButton.disabled = true;
            getFeedbackButton.textContent = 'ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...';
            // --- [MODIFIED] ë¡œë” ë¡œì§ ë³€ê²½ ---
            analysisSection.classList.add('hidden'); // ë¶„ì„ ì„¹ì…˜ ìˆ¨ê¹€
            // feedbackSkeleton.classList.remove('hidden'); // [DELETED]
            const feedbackMessages = [
                "ì„±ì¥ ë¦¬í¬íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...",
                "ì‚¬ê³  ê³¼ì •ì„ ì •ë°€ ì±„ì  ì¤‘ì…ë‹ˆë‹¤...",
                "S-Class í”¼ë“œë°±ì„ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
            ];
            showDynamicLoader(feedbackMessages); // [NEW]
            errorBanner.classList.add('hidden'); // ê¸°ì¡´ ì˜¤ë¥˜ ìˆ¨ê¹€

            try {
                const feedback = await callGeminiApi(FEEDBACK_PROMPT(userAnalyses));
                displayFeedbackReport(feedback);
                feedbackReportSection.classList.remove('hidden'); // ë¦¬í¬íŠ¸ ì„¹ì…˜ í‘œì‹œ
                 window.scrollTo(0, 0); // í˜ì´ì§€ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            } catch (error) {
                console.error('Error getting feedback:', error);
                 showError(`í”¼ë“œë°±ì„ ë°›ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); // [MODIFIED]
                 analysisSection.classList.remove('hidden'); // ì˜¤ë¥˜ ì‹œ ë¶„ì„ ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
            } finally {
                getFeedbackButton.disabled = false;
                getFeedbackButton.textContent = 'ë¶„ì„ ì™„ë£Œ & ì„±ì¥ ë¦¬í¬íŠ¸ ë³´ê¸°';
                // --- [MODIFIED] ë¡œë” ë¡œì§ ë³€ê²½ ---
                // feedbackSkeleton.classList.add('hidden'); // [DELETED]
                hideDynamicLoader(); // [NEW]
            }
        }

        // --- [NEW] Display Feedback Report ---
         function displayFeedbackReport(feedback) {
            if (typeof feedback!== 'object' || feedback === null) {
                console.error("Invalid feedback format:", feedback);
                // [MODIFIED] ì˜¤ë¥˜ ì²˜ë¦¬
                showError('AIë¡œë¶€í„° ìœ íš¨í•œ JSON í”¼ë“œë°±ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                analysisSection.classList.remove('hidden'); // ë¶„ì„ ì„¹ì…˜ìœ¼ë¡œ ë³µê·€
                return;
            }

            const {
                score = 0,
                criteria_scores = { instinct: 0, rebuttal: 0, psychology: 0, customer_success: 0 },
                good_points = [],
                improvement_points = [],
                action_plan = 'ë‹¤ìŒ í›ˆë ¨ ëª©í‘œë¥¼ ì„¤ì •í•˜ì„¸ìš”.'
             } = feedback;


            // 1. ì ìˆ˜ ë° ìš”ì•½ í‘œì‹œ
            let scoreClass = 'score-c'; // Default C (0-39)
            if (score >= 85) scoreClass = 'score-s';
            else if (score >= 60) scoreClass = 'score-a';
            else if (score >= 40) scoreClass = 'score-b';


            let summary = 'ì•„ì§ ê°œì„ ì´ ë§ì´ í•„ìš”í•©ë‹ˆë‹¤. í”¼ë“œë°±ì„ í†µí•´ ê¸°ë³¸ê¸°ë¥¼ ë‹¤ì§€ì„¸ìš”.';
            if (score >= 85) summary = 'í›Œë¥­í•©ë‹ˆë‹¤! S-Class ë§ˆì¼€í„°ì˜ ì‚¬ê³ ë°©ì‹ì´ ë³´ì…ë‹ˆë‹¤.';
            else if (score >= 60) summary = 'ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤. í•µì‹¬ ì›ë¦¬ë¥¼ ê±°ì˜ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤.';
            else if (score >= 40) summary = 'ì„±ì¥ì˜ ê°€ëŠ¥ì„±ì´ ë³´ì…ë‹ˆë‹¤. í”¼ë“œë°±ì„ í†µí•´ í•µì‹¬ì„ íŒŒì•…í•˜ì„¸ìš”.';


            feedbackScoreEl.textContent = `${score}ì `;
            feedbackScoreEl.className = scoreClass; // ì ìˆ˜ ìƒ‰ìƒ ì ìš©
            feedbackSummaryEl.textContent = safeHtml(summary);

             // 2. ë ˆì´ë” ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
            renderRadarChart(criteria_scores);

            // 3. ìƒì„¸ í”¼ë“œë°± ëª©ë¡ í‘œì‹œ (ë§ˆí¬ë‹¤ìš´ ì œê±° í™•ì¸)
            goodPointsList.innerHTML = good_points.map(p => `<li>${safeHtml(p)}</li>`).join('');
            improvementPointsList.innerHTML = improvement_points.map(p => `<li>${safeHtml(p)}</li>`).join('');


             // 4. ì•¡ì…˜ í”Œëœ í‘œì‹œ
            actionPlanText.textContent = safeHtml(action_plan);

             // 5. ì…€í”„ ì½”ì¹­ ì§ˆë¬¸ì€ HTMLì— ê³ ì •ë˜ì–´ ìˆìŒ

        }

        // --- [NEW] Render Radar Chart ---
        function renderRadarChart(scores) {
            const ctx = feedbackChartCanvas.getContext('2d');
            const labels = ['ë³¸ëŠ¥ ë¶„ì„', 'ë°˜ë°• ì œê±°', 'ì‹¬ë¦¬í•™ ì›ë¦¬', 'ê³ ê° ì„±ê³µ'];
            const data = [
                scores.instinct || 0,
                scores.rebuttal || 0,
                scores.psychology || 0,
                scores.customer_success || 0
            ];

            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´ í›„ ë‹¤ì‹œ ê·¸ë¦¼
             if (feedbackChart) {
                feedbackChart.destroy();
            }


            feedbackChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ìª¼ê°œê¸° ì—­ëŸ‰ ì ìˆ˜',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(74, 128, 243, 0.2)', // íŒŒë‘ íˆ¬ëª…
                        borderColor: 'rgb(74, 128, 243)', // íŒŒë‘
                        pointBackgroundColor: 'rgb(74, 128, 243)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(77, 128, 243)'
                    }]
                },
                options: {
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                     scale: {
                         r: {
                             angleLines: {
                                display: false
                             },
                             suggestedMin: 0,
                             suggestedMax: 100,
                             ticks: {
                                 stepSize: 20 // 0, 20, 40, 60, 80, 100
                            }
                         }
                    },
                     plugins: {
                        legend: {
                             display: false // ë²”ë¡€ ìˆ¨ê¹€
                        }
                    }
                }
            });
        }


        // --- [NEW] Reset UI Function ---
         function resetUI() {
             // 1. ì„¹ì…˜ í‘œì‹œ ìƒíƒœ ì´ˆê¸°í™”
            inputSection.classList.remove('hidden');
            analysisSection.classList.add('hidden');
            feedbackReportSection.classList.add('hidden');
            errorBanner.classList.add('hidden'); // [NEW]
            // --- [DELETED] ìŠ¤ì¼ˆë ˆí†¤ ìˆ¨ê¹€ ---
            // analysisSkeleton.classList.add('hidden');
            // feedbackSkeleton.classList.add('hidden');
            hideDynamicLoader(); // [NEW]

             // 2. ì…ë ¥ê°’ ì´ˆê¸°í™”
            textInput.value = '';
            courseOptions.forEach(o => o.classList.remove('selected'));
            selectedCourse = null;
            originalChunks = [];
            analysisInputsContainer.innerHTML = ''; // ë¶„ì„ ì¹´ë“œ ì œê±°
            updateCharCounter(); // [NEW]
            progressIndicator.textContent = ''; // [NEW]

             // 3. ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            startSplitButton.disabled = true;

             // 4. ì°¨íŠ¸ íŒŒê´´ (ë‹¤ì‹œ ê·¸ë¦´ ë•Œ ìƒì„±)
             if (feedbackChart) {
                 feedbackChart.destroy();
                 feedbackChart = null;
             }
              window.scrollTo(0, 0); // í˜ì´ì§€ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
         }


        // --- [START] REAL API CALL LOGIC ---
        // (Includes exponential backoff and JSON parsing)
        async function callGeminiApi(prompt) {
            console.log("Sending prompt to API:", prompt);
             let retries = 0;
             const maxRetries = 3;
             const baseDelay = 1000; // 1 second

             while(retries < maxRetries) {
                 try {
                     const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                responseMimeType: "application/json", // Expect JSON response
                            },
                            safetySettings: [
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                // --- [START] 400 ì˜¤ë¥˜ ìˆ˜ì • (ì´ì „ ìˆ˜ì •ì‚¬í•­) ---
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } // "DANGS" -> "DANGEROUS"
                                // --- [END] 400 ì˜¤ë¥˜ ìˆ˜ì • (ì´ì „ ìˆ˜ì •ì‚¬í•­) ---
                            ]
                        })
                    });

                    if (!response.ok) {
                         if (response.status === 429 || response.status >= 500) {
                             retries++;
                             if (retries >= maxRetries) throw new Error(`API í˜¸ì¶œì´ ${maxRetries}ë²ˆì˜ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (Status: ${response.status}).`);
                             const delay = baseDelay * Math.pow(2, retries);
                             console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms... (${retries}/${maxRetries})`);
                             await new Promise(resolve => setTimeout(resolve, delay));
                             continue;
                         } else {
                            const errorBody = await response.text();
                            console.error("API Error Body:", errorBody);
                            throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                         }
                    }

                    const data = await response.json();

                    // ì‘ë‹µ êµ¬ì¡° ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
                     if (!data.candidates || data.candidates.length === 0 ||!data.candidates[0].content ||!data.candidates[0].content.parts || data.candidates[0].content.parts.length === 0) {
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
                            throw new Error("AIê°€ ì•ˆì „ìƒì˜ ì´ìœ ë¡œ ì‘ë‹µì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.");
                        }
                        if (data.promptFeedback && data.promptFeedback.blockReason) {
                             throw new Error(`API ìš”ì²­ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.promptFeedback.blockReason}`);
                        }
                         console.error("Invalid API Response Structure:", data);
                         throw new Error("AIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µ êµ¬ì¡°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }


                    const jsonString = data.candidates[0].content.parts[0].text;

                    try {
                        // JSON íŒŒì‹± ì‹œë„
                        const parsedResult = JSON.parse(jsonString);
                        // SPLIT_PROMPTëŠ” ë°°ì—´ì„ ë°˜í™˜í•´ì•¼ í•¨
                         if (prompt.includes('Jjokegi Theory') && !Array.isArray(parsedResult)) {
                             console.error("Split prompt did not return an array:", parsedResult);
                             throw new Error("AIê°€ í…ìŠ¤íŠ¸ ìª¼ê°œê¸° ê²°ê³¼ë¥¼ ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                         }
                         // FEEDBACK_PROMPTëŠ” ê°ì²´ë¥¼ ë°˜í™˜í•´ì•¼ í•¨
                         if (!prompt.includes('Jjokegi Theory') && (typeof parsedResult !== 'object' || parsedResult === null || Array.isArray(parsedResult))) {
                             console.error("Feedback prompt did not return an object:", parsedResult);
                             throw new Error("AIê°€ í”¼ë“œë°± ê²°ê³¼ë¥¼ ê°ì²´ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                         }
                        return parsedResult;
                    } catch (parseError) {
                        console.error("Failed to parse JSON response:", jsonString, parseError);
                        throw new Error("AIê°€ ìœ íš¨í•œ JSON í˜•ì‹ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }

                } catch (error) {
                    console.error("API Error during fetch or processing:", error);
                     if (retries >= maxRetries) {
                         throw error; // ìµœì¢… ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ ë˜ì§
                     }
                     // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± ì¬ì‹œë„ ê°€ëŠ¥í•œ ì˜¤ë¥˜ ì²˜ë¦¬
                     // --- [START] ì¬ì‹œë„ ë¡œì§ ìˆ˜ì • (ì´ì „ ìˆ˜ì •ì‚¬í•­) ---
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                     // --- [END] ì¬ì‹œë„ ë¡œì§ ìˆ˜ì • (ì´ì „ ìˆ˜ì •ì‚¬í•­) ---
                        retries++;
                        const delay = baseDelay * Math.pow(2, retries);
                        console.warn(`API/Network error. Retrying in ${delay}ms... (${retries}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // ë‹¤ìŒ ì¬ì‹œë„
                    } else {
                        // JSON íŒŒì‹± ì˜¤ë¥˜, 400 ì˜¤ë¥˜ ë“± ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ì˜¤ë¥˜ëŠ” ì¦‰ì‹œ ë˜ì§
                        throw error;
                    }
                }
             }
              // ì´ë¡ ì ìœ¼ë¡œëŠ” ì—¬ê¸°ì— ë„ë‹¬í•˜ì§€ ì•Šì•„ì•¼ í•¨
             throw new Error(`API í˜¸ì¶œì´ ${maxRetries}ë²ˆì˜ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
        }
        // --- [END] REAL API CALL LOGIC ---

        // Helper function for safe HTML display
        function safeHtml(text) {
          return text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì¹´ìš´í„° ìƒíƒœ ì—…ë°ì´íŠ¸
        updateCharCounter();
    </script>
</body>
</html>