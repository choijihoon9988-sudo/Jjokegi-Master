<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìª¼ê°œê¸° ë§ˆìŠ¤í„° v2.2 (Report Polished)</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- [v2.1] ì•„ì´ë””ì–´ 9: 'ìˆ¨ ì‰´ ê³µê°„' ë° íƒ€ì´í¬ê·¸ë˜í”¼ ì›ì¹™ ì ìš© --- */
        :root {
            --primary-color: #4A80F3;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ê°€ë…ì„±ì„ ìœ„í•´ ìˆœìˆ˜ ê²€ì •(#000) ëŒ€ì‹  ì§„íšŒìƒ‰ ì‚¬ìš© */
            --text-color: #222222; 
            --light-bg-color: #f9f9f9;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --white-color: #FFFFFF;
            --font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--white-color);
            color: var(--text-color);
            /* [v2.1] ì•„ì´ë””ì–´ 9: ê¸°ë³¸ í–‰ê°„ ì¦ê°€ (1.6 -> 1.7) */
            line-height: 1.7; 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 16px; /* [v2.1] ì•„ì´ë””ì–´ 9: ê¸°ë³¸ í°íŠ¸ í¬ê¸° ì„¤ì • */
        }

       .container {
            width: 100%;
            max-width: 800px;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ìƒí•˜ ì—¬ë°± ì¦ê°€ (40px -> 56px) */
            padding: 56px 20px; 
            box-sizing: border-box;
        }

        header {
            text-align: center;
            /* [v2.1] ì•„ì´ë””ì–´ 9: í•˜ë‹¨ ì—¬ë°± ì¦ê°€ (40px -> 48px) */
            margin-bottom: 48px; 
        }

        header h1 {
            /* [v2.1] ì•„ì´ë””ì–´ 9: íƒ€ì´í¬ê·¸ë˜í”¼ ìŠ¤ì¼€ì¼ (36px -> 40px) */
            font-size: 40px; 
            font-weight: 800;
            margin: 0;
            color: var(--primary-color);
        }

        header p {
            /* [v2.1] ì•„ì´ë””ì–´ 9: íƒ€ì´í¬ê·¸ë˜í”¼ ìŠ¤ì¼€ì¼ (18px -> 19px) */
            font-size: 19px; 
            /* [v2.1] ì•„ì´ë””ì–´ 10: í†¤ ë‹¤ìš´ ( #666 -> #555 ) */
            color: #555; 
            margin-top: 12px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
        }

        #error-banner {
            background-color: var(--danger-color);
            color: var(--white-color);
            padding: 16px 24px;
            border-radius: 8px;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            margin-bottom: 32px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        #error-message { font-weight: 600; margin: 0; }
        #error-close {
            background: none; border: none; color: var(--white-color);
            font-size: 24px; font-weight: 700; cursor: pointer;
            padding: 0 8px; line-height: 1; opacity: 0.8; transition: opacity 0.2s;
        }
        #error-close:hover { opacity: 1; }

       .main-card {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì¹´ë“œ ë‚´ë¶€ ì—¬ë°± ì¦ê°€ (32px -> 40px) */
            padding: 40px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.05); /* [v2.1] ì•„ì´ë””ì–´ 9: ê·¸ë¦¼ì ë¯¸ì„¸ ì¡°ì • */
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì¹´ë“œ ê°„ ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            margin-bottom: 32px; 
        }

        /* --- ì…ë ¥ ì„¹ì…˜ --- */
        #input-section h2, #analysis-section h2, #feedback-report-section h2 {
            /* [v2.1] ì•„ì´ë””ì–´ 9: íƒ€ì´í¬ê·¸ë˜í”¼ ìŠ¤ì¼€ì¼ (24px -> 28px) */
            font-size: 28px; 
            font-weight: 800; /* [v2.1] ì•„ì´ë””ì–´ 9: ê°•ì¡° */
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
            margin-bottom: 24px; 
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }
         #input-section h2:first-of-type { margin-top: 0; }

        #text-input {
            width: 100%; height: 180px; padding: 16px;
            border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-family); font-size: 16px;
            resize: vertical; box-sizing: border-box; margin-bottom: 8px;
        }

        #char-counter {
            text-align: right; font-size: 14px;
            font-weight: 500; color: var(--danger-color);
        }
        #char-counter.sufficient {
            color: var(--success-color); font-weight: 600;
        }

       .course-options { margin-top: 24px; display: flex; gap: 16px; }
       .course-option {
            flex: 1; padding: 20px; border: 1px solid var(--border-color); /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
            text-align: center;
        }
       .course-option:hover,.course-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 128, 243, 0.2); /* [v2.1] ì•„ì´ë””ì–´ 9: ê°•ì¡° */
        }
       .course-option h3 { margin: 0 0 8px 0; font-size: 17px; font-weight: 700; } /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
       .course-option p { margin: 0; font-size: 15px; color: #555; }

       .btn {
            display: block; width: 100%; padding: 18px; /* [v2.1] ì•„ì´ë””ì–´ 9: ë²„íŠ¼ í¬ê¸° ì¦ê°€ */
            margin-top: 32px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ */
            background-color: var(--primary-color);
            color: var(--white-color); border: none; border-radius: 8px;
            font-size: 18px; font-weight: 700; cursor: pointer;
            transition: background-color 0.2s ease; box-sizing: border-box;
        }
       
       /* [v2.2] PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ìœ„í•œ 2ìˆœìœ„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
       .btn-secondary { 
            background-color: #6c757d; 
            margin-top: 32px; 
        } 
       .btn-secondary:hover { background-color: #5a6268; }
       
       /* [v2.2] 'ìƒˆ í›ˆë ¨' ë²„íŠ¼ê³¼ì˜ ê°„ê²© ì¡°ì • */
       #reset-button {
           margin-top: 16px;
       }
       
       .btn:hover { background-color: #3a6cc7; }
       .btn:disabled { background-color: #a0b9e8; cursor: not-allowed; }

        /* --- [v2.0] í›ˆë ¨ ì„¹ì…˜ (í¬ì»¤ìŠ¤ ëª¨ë“œ) --- */
        #analysis-section h2 {
            text-align: center;
            border-bottom: none; /* í¬ì»¤ìŠ¤ ëª¨ë“œì—ì„œëŠ” ì œëª© ë°‘ì¤„ ì œê±° */
            margin-bottom: 12px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
        }
        #progress-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 24px; /* ì¹´ë“œì™€ ê°„ê²© */
        }

        /* í›ˆë ¨ ì¹´ë“œ (ë‹¨ì¼) */
       .chunk-card {
            background: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 24px; /* ë²„íŠ¼ê³¼ ê°„ê²© */
            /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
            padding: 32px; 
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* ì¢Œìš° ë¶„í•  */
            gap: 32px; /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ê°„ê²© ì¦ê°€ */
        }
       .original-text-container {
            background-color: var(--light-bg-color);
            padding: 20px; border-radius: 8px; border: 1px solid #eee; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
        }
       .original-text-container h4 {
            margin: 0 0 12px 0; font-size: 15px; font-weight: 700; /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
            color: #555; display: flex; align-items: center; gap: 6px;
       }
       .original-text-container h4::before { content: 'ğŸ“„'; }
        p.original-text {
            font-size: 16px; line-height: 1.7; margin: 0;
            word-break: keep-all;
        }
       .analysis-input-container h4 {
            margin: 0 0 12px 0; font-size: 15px; font-weight: 700; /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
            color: var(--primary-color); display: flex; align-items: center; gap: 6px;
       }
        .analysis-input-container h4::before { content: 'âœï¸'; }

        textarea.analysis-input {
            width: 100%; height: 160px; padding: 14px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
            border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-family); font-size: 16px; /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
            resize: vertical; box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea.analysis-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 128, 243, 0.2); /* [v2.1] ì•„ì´ë””ì–´ 9: ê°•ì¡° */
            outline: none;
        }
        textarea.analysis-input.invalid {
            border: 1px solid var(--danger-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2); /* [v2.1] ì•„ì´ë””ì–´ 9: ê°•ì¡° */
        }
        /* --- [END v2.0] í›ˆë ¨ ì„¹ì…˜ --- */


        /* --- [v2.1] í”¼ë“œë°± ë¦¬í¬íŠ¸ ì„¹ì…˜ --- */
        #feedback-report-section {
            width: 100%; max-width: 800px;
            padding: 0; box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
        }
        
        /* [v2.1] ì•„ì´ë””ì–´ 1: ì ìˆ˜ ì‹œê°í™” (í—¤ë” ë‹¨ìˆœí™”) */
        .report-header {
            text-align: center; 
            /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ (32px -> 48px) */
            padding: 48px 32px; 
            border-radius: 12px;
        }
        .report-header h2 {
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì ìˆ˜ ê°•ì¡°ë¥¼ ìœ„í•´ ì œëª©ì€ ì¶•ì†Œ (28px -> 24px) */
            font-size: 24px; 
            margin: 0 0 24px 0; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± í™•ë³´ */
            color: #555; /* [v2.1] ì•„ì´ë””ì–´ 10: í†¤ ë‹¤ìš´ */
            font-weight: 700;
            border-bottom: none;
        }
        #feedback-score-container { text-align: center; }
        
        /* [v2.1] ì•„ì´ë””ì–´ 1: 'ë‹¨ì¼ ì§„ì‹¤ ê³µê¸‰ì›' ë ˆì´ë¸” */
        #feedback-score-label {
            font-size: 16px; 
            font-weight: 600; 
            color: #555; 
            margin: 0 0 8px 0; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* [v2.1] ì•„ì´ë””ì–´ 1: 'ë‹¨ì¼ ì§„ì‹¤ ê³µê¸‰ì›' ì ìˆ˜ */
        #feedback-score {
            /* [v2.1] ì•„ì´ë””ì–´ 9: íƒ€ì´í¬ê·¸ë˜í”¼ ìŠ¤ì¼€ì¼ (96px -> 104px) */
            font-size: 104px; 
            font-weight: 900;
            margin: 0; 
            line-height: 1;
        }
       .score-s { color: var(--success-color); } /* 85+ */
       .score-a { color: var(--primary-color); } /* 60-84 */
       .score-b { color: var(--warning-color); } /* 40-59 */
       .score-c { color: var(--danger-color); }  /* 0-39 */
        
       /* [v2.1] ì•„ì´ë””ì–´ 2: ë™ê¸°ë¶€ì—¬ ìš”ì•½ë¬¸ */
       #feedback-summary {
            /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • (22px -> 20px) */
            font-size: 20px; 
            font-weight: 600;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ (8px -> 16px) */
            margin-top: 16px; 
            margin-bottom: 32px; 
            color: #444; /* [v2.1] ì•„ì´ë””ì–´ 10: í†¤ ì¡°ì • */
            /* [v2.1] ì•„ì´ë””ì–´ 9: ê°€ë…ì„±ì„ ìœ„í•œ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            max-width: 450px; 
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        /* [v2.0] ë ˆì´ë” ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ - ìˆ¨ê¹€ */
        #chart-container {
             display: none;
        }

        /* [v2.0] S-Class 1:1 ìƒì„¸ ì½”ì¹­ */
        #detailed-review-container {
            display: flex;
            flex-direction: column;
            gap: 24px; /* ë¦¬ë·° ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
        }
        .review-card {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden; /* í—¤ë”ì˜ ë¼ìš´ë“œ ì½”ë„ˆ ì ìš© */
        }
        .review-card-header {
            background-color: var(--light-bg-color);
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
            padding: 16px 24px; 
            border-bottom: 1px solid var(--border-color);
        }
        .review-card-header h4 {
            margin: 0; font-size: 17px; font-weight: 700; /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
        }
        .review-card-body {
            /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ (20px -> 24px) */
            padding: 24px; 
            display: grid;
            grid-template-columns: 1fr 1fr; /* ì¢Œ: ë‚´ ë¶„ì„, ìš°: ì½”ì¹˜ í”¼ë“œë°± */
            gap: 24px; /* [v2.1] ì•„ì´ë””ì–´ 9: ê°„ê²© ì¦ê°€ */
        }
        .review-card-body .original-text-container {
            /* 1:1 ë¦¬ë·°ì—ì„œëŠ” ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ í—¤ë”ë¡œ ì˜¬ë ¸ìœ¼ë¯€ë¡œ ìˆ¨ê¹€ */
            display: none;
        }
        .user-analysis-box, .coach-feedback-box {
            background-color: var(--white-color);
            border-radius: 8px;
            padding: 20px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ */
        }
        .user-analysis-box {
            border: 1px solid var(--success-color);
            background-color: #f6fff8;
        }
        .coach-feedback-box {
            border: 1px solid var(--primary-color);
            background-color: #f7f9ff;
        }
        .review-card h5 {
            /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • (15px -> 16px) */
            margin: 0 0 12px 0; font-size: 16px; font-weight: 700; 
            display: flex; align-items: center; gap: 8px;
        }
        .user-analysis-box h5 { color: var(--success-color); }
        .user-analysis-box h5::before { content: 'âœ”ï¸'; }
        .coach-feedback-box h5 { color: var(--primary-color); }
        .coach-feedback-box h5::before { content: 'ğŸ“ˆ'; }

        .review-card p {
            margin: 0; font-size: 15px; line-height: 1.7;
            color: #444; word-break: keep-all;
        }
        .review-card p.empty-analysis {
            color: #888;
            font-style: italic;
        }

        /* [v2.2] í”¼ë“œë°± ê°€ë…ì„± í–¥ìƒ */
        .coach-feedback-box p strong {
            color: var(--primary-color);
            font-weight: 700;
            display: inline-block;
            margin-top: 8px;
            margin-bottom: 2px;
            font-size: 15px;
        }
        .coach-feedback-box p strong:first-of-type {
            margin-top: 0;
        }


        /* [v2.1] ì•„ì´ë””ì–´ 5: 'í”¼ë“œë°±-ì‹¤ì²œ' ì—°ê²° ë²„íŠ¼ */
        .btn-use-as-lesson {
            background: none;
            border: none;
            color: var(--primary-color);
            font-family: var(--font-family);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            margin-top: 16px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± */
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        .btn-use-as-lesson:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* í”¼ë“œë°± ìš”ì•½ íŒ¨ë„ */
       .feedback-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            text-align: left;
            margin-bottom: 32px;
        }
       .feedback-panel {
            background-color: var(--light-bg-color);
            /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            border-radius: 8px; padding: 32px; 
        }
       .feedback-panel h3 {
            /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • (18px -> 20px) */
            margin: 0 0 16px 0; font-size: 20px; 
            display: flex; align-items: center;
            gap: 8px; font-weight: 700;
       }
        #good-points-panel h3 { color: var(--success-color); }
        #improvement-points-panel h3 { color: var(--warning-color); }
       .feedback-panel ul { list-style-type: none; padding: 0; margin: 0; }
       .feedback-panel li {
            margin-bottom: 12px; font-size: 16px; line-height: 1.7; /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
            padding-left: 24px; position: relative; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
       }
       #good-points-panel li::before {
           content: 'ğŸ‘'; position: absolute; left: 0; top: 2px;
       }
        #improvement-points-panel li::before {
           content: 'ğŸ“ˆ'; position: absolute; left: 0; top: 2px;
       }

        /* [v2.1] ì•„ì´ë””ì–´ 4: 'ê°€ì¥ ì¤‘ìš”í•œ í•œ ê°€ì§€' ì‹¤ì²œ ê³„íš */
        .action-plan-section {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            border-radius: 12px; padding: 32px;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            margin-bottom: 32px; 
        }
         .action-plan-section h3 {
             /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • (18px -> 20px) */
             font-size: 20px; font-weight: 700; 
             margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
             color: var(--primary-color);
         }
        .action-plan-section h3::before { content: 'ğŸ¯'; }
         .action-plan-section p {
             font-size: 16px; line-height: 1.7; margin: 0 0 16px 0; color: #555; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¶”ê°€ */
         }
         #action-plan-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            font-family: var(--font-family);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s ease;
         }
         #action-plan-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 128, 243, 0.2);
            outline: none;
            background-color: var(--white-color); /* [v2.1] ì•„ì´ë””ì–´ 5: í¬ì»¤ìŠ¤ ì‹œ ë°°ê²½ìƒ‰ ì›ë³µ */
         }
         #action-plan-counter {
            text-align: right;
            font-size: 14px;
            color: #888;
            margin-top: 8px;
         }
         
        /* [v2.1] ì•„ì´ë””ì–´ 6: 'ì†Œí¬ë¼í…ŒìŠ¤ì‹' ì…€í”„ ì½”ì¹­ */
        .self-coaching-section {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            /* [v2.1] ì•„ì´ë””ì–´ 9: ë‚´ë¶€ ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            border-radius: 12px; padding: 32px; 
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ (24px -> 32px) */
            margin-bottom: 32px; 
        }
         .self-coaching-section h3 {
             /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • (18px -> 20px) */
             font-size: 20px; font-weight: 700; 
             margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
             color: var(--primary-color);
         }
        .self-coaching-section h3::before { content: 'ğŸ¤”'; }
         /* [v2.1] ì•„ì´ë””ì–´ 6: ë™ì  ì§ˆë¬¸ ìŠ¤íƒ€ì¼ */
         #socratic-question {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 0 16px 0;
            padding: 16px;
            background-color: var(--light-bg-color);
            border-radius: 8px;
            line-height: 1.6;
         }
         /* [v2.1] ì•„ì´ë””ì–´ 6: ì…ë ¥ ì˜ì—­ */
         #self-coaching-input {
            width: 100%;
            height: 100px;
            padding: 14px 16px;
            font-size: 16px;
            font-family: var(--font-family);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            resize: vertical;
         }
         #self-coaching-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 128, 243, 0.2);
            outline: none;
         }

        /* --- [END v2.1] í”¼ë“œë°± ë¦¬í¬íŠ¸ --- */


        /* ë™ì  ë¡œë” ìŠ¤íƒ€ì¼ */
        #dynamic-loader {
            text-align: center; padding: 48px;
            flex-direction: column; gap: 24px;
            align-items: center; justify-content: center;
        }
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        #loader-text {
            font-size: 18px; font-weight: 600;
            color: var(--text-color); margin: 0;
        }

        footer {
            text-align: center; padding: 20px;
            font-size: 14px; color: #999;
            /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¦ê°€ (40px -> 64px) */
            margin-top: 64px; 
        }

        .hidden { display: none !important; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
           .container { padding: 24px 15px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
           header h1 { font-size: 30px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
           header p { font-size: 17px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ìŠ¤ì¼€ì¼ ì¡°ì • */
           .main-card { padding: 24px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
           .chunk-card { padding: 20px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
           .feedback-panel { padding: 24px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
           .action-plan-section, .self-coaching-section { padding: 24px; } /* [v2.1] ì•„ì´ë””ì–´ 9: ì—¬ë°± ì¡°ì • */
           
           #text-input { height: 150px; }
           .course-options { flex-direction: column; }
           .chunk-card { grid-template-columns: 1fr; } /* í›ˆë ¨ ì¹´ë“œ ì„¸ë¡œ ì •ë ¬ */
           
           /* [v2.1] ì•„ì´ë””ì–´ 1: ëª¨ë°”ì¼ ì ìˆ˜ ìŠ¤ì¼€ì¼ ì¡°ì • */
           #feedback-score { font-size: 80px; } 
           #feedback-summary { font-size: 18px; }
           
           /* [v2.0] ìƒì„¸ ë¦¬ë·° ì¹´ë“œ ì„¸ë¡œ ì •ë ¬ */
           .review-card-body { grid-template-columns: 1fr; }
           .feedback-details { grid-template-columns: 1fr; } /* ìš”ì•½ íŒ¨ë„ ì„¸ë¡œ ì •ë ¬ */
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ìª¼ê°œê¸° ë§ˆìŠ¤í„°</h1>
            <p>ë§¤ì¼ ìª¼ê°œë©° í›ˆë ¨í•˜ê³ , ë³¸ì§ˆì„ ê¿°ëš«ëŠ” ë§ˆìŠ¤í„°ê°€ ë˜ì„¸ìš”.</p>
        </header>

        <div id="error-banner" class="hidden">
            <p id="error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <button id="error-close" type="button" aria-label="ë‹«ê¸°">&times;</button>
        </div>

        <div id="dynamic-loader" class="main-card hidden">
            <div class="spinner"></div>
            <p id="loader-text">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div class="main-card" id="input-section">
            <h2>1. í›ˆë ¨í•  í…ìŠ¤íŠ¸ ì…ë ¥</h2>
            <textarea id="text-input" placeholder="í›ˆë ¨í•˜ê³  ì‹¶ì€ ë¸”ë¡œê·¸ ê¸€, ì˜ìƒ ëŒ€ë³¸, ì¹´í”¼ ë“±ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (50ì ì´ìƒ)"></textarea>
            <div id="char-counter">0 / 50ì</div>

            <h2 style="margin-top: 32px;">2. í›ˆë ¨ ì½”ìŠ¤ ì„ íƒ</h2>
            <div class="course-options">
                <div class="course-option" data-course="quick">
                    <h3>Quick Course</h3>
                    <p>í•µì‹¬ ì˜ë¯¸ 5ê°œ ìª¼ê°œê¸°<br>(ì „ëµì  í•µì‹¬ ì ê²€)</p>
                </div>
                <div class="course-option" data-course="medium">
                    <h3>Medium Course</h3>
                    <p>ì£¼ìš” ì˜ë¯¸ 10ê°œ ìª¼ê°œê¸°<br>(í•µì‹¬ ë…¼ë¦¬ ì§‘ì¤‘ í›ˆë ¨)</p>
                </div>
                <div class="course-option" data-course="full">
                    <h3>Full Course</h3>
                    <p>ì „ì²´ í…ìŠ¤íŠ¸ ìª¼ê°œê¸°<br>(ì‹¬ì¸µ ì§‘ì¤‘ í›ˆë ¨)</p>
                </div>
            </div>

            <button id="start-split-button" class="btn" disabled>ìª¼ê°œê¸° í›ˆë ¨ ì‹œì‘</button>
        </div>

        <div id="analysis-section" class="hidden">
            <h2>S-Class: ì§‘ì¤‘ í›ˆë ¨</h2>
            <p id="progress-indicator">0 / 0 í•­ëª© í›ˆë ¨ ì¤‘</p>
            <div id="analysis-inputs"></div>
            <button id="next-chunk-button" class="btn">ë‹¤ìŒ â”</button>
        </div>

        <div id="feedback-report-section" class="hidden">
            <div class="main-card report-header">
                <h2>ğŸ“Š ì„±ì¥ ë¦¬í¬íŠ¸</h2>
                 <div id="feedback-score-container">
                    <p id="feedback-score-label">ë¶„ì„ ì •í™•ë„</p>
                    <div id="feedback-score"></div>
                    <p id="feedback-summary"></p>
                 </div>
            </div>

            <div class="main-card" style="margin-top: 32px;">
                <h2 style="text-align: center; margin-bottom: 8px;">S-Class: 1:1 ìƒì„¸ ì½”ì¹­</h2>
                <p style="text-align: center; margin-top: -8px; margin-bottom: 32px; font-size: 16px; color: #666;">
                    AI ì½”ì¹˜ê°€ ë‹¹ì‹ ì˜ í›ˆë ¨ì„ 1:1ë¡œ ì½”ì¹­í•©ë‹ˆë‹¤.
                </p>
                <div id="detailed-review-container">
                    </div>
            </div>

             <div class="main-card">
                 <h2 style="text-align: center;">ğŸ“ˆ í›ˆë ¨ ê²°ê³¼ (ìš”ì•½)</h2>
                 
                 <div class="feedback-details">
                    <div class="feedback-panel" id="good-points-panel">
                        <h3>ê°•ì </h3>
                        <ul id="good-points-list"></ul>
                    </div>
                    <div class="feedback-panel" id="improvement-points-panel">
                        <h3>ë³´ì™„ì </h3>
                        <ul id="improvement-points-list"></ul>
                    </div>
                 </div>
            </div>

            <div class="action-plan-section">
                 <h3>ğŸ¯ ê°€ì¥ ì¤‘ìš”í•œ í•œ ê°€ì§€ (My Next Step)</h3>
                 <p>ì´ë²ˆ í›ˆë ¨ì—ì„œ ì–»ì€ ê°€ì¥ ì¤‘ìš”í•œ í•œ ê°€ì§€ êµí›ˆì€ ë¬´ì—‡ì¸ê°€ìš”?</p>
                 <input type="text" id="action-plan-input" placeholder="AIì˜ ì œì•ˆ ë˜ëŠ” ë‚˜ì˜ ìƒê°ì„ 140ì ë‚´ë¡œ ìš”ì•½..." maxlength="140">
                 <div id="action-plan-counter">0 / 140ì</div>
             </div>

             <div class="self-coaching-section">
                 <h3>ğŸ¤” ì„±ì¥ì„ ìœ„í•œ ì„±ì°°</h3>
                 <h4 id="socratic-question"></h4>
                 <textarea id="self-coaching-input" placeholder="ë‚˜ì˜ ìƒê°ì„ ì •ë¦¬í•´ë³´ì„¸ìš”..."></textarea>
             </div>
             
             <button id="download-pdf-button" class="btn btn-secondary">ğŸ“ˆ ë¦¬í¬íŠ¸ PDFë¡œ ì €ì¥</button>

             <button id="reset-button" class="btn">ìƒˆë¡œìš´ í›ˆë ¨ ì‹œì‘í•˜ê¸°</button>
        </div>

    </div> 
    
    <footer>
        <p>Â© 2025 Jjokegi Master. ì´ìƒí•œë§ˆì¼€íŒ… êµ¬ì„±ì› ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>
    </footer>

    <script>
        // --- AI CONFIGURATION ---
        // !!! ì¤‘ìš” !!!: í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‹¤ì œ Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ "..." ì•ˆì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const GEMINI_API_KEY = "AIzaSyCVTLte-n_F-83vTq3P1Fc16NzGXdKaIYI"; // â¬…ï¸ ì—¬ê¸°ì— ì‹¤ì œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        // ë§Œì•½ í‚¤ê°€ ì—†ë‹¤ë©´, https://aistudio.google.com/app/apikey ì—ì„œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        
        // --- [v2.0] S-Class AI Prompts ---

        // ìª¼ê°œê¸° í”„ë¡¬í”„íŠ¸ (v1.2ì™€ ë™ì¼, ì´ë¯¸ Sê¸‰)
        const SPLIT_PROMPT = (text, mode) => {
            const coreInstruction = `
                You are an expert in Jacheong's 'Jjokegi Theory'. Your task is to analyze the *entire* text provided below to find the 'Minimum Viable Meaning Units' (ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„) that a master marketer would identify.
                A 'Minimum Viable Meaning Unit' is an individual claim, psychological hook, setup/payoff pair, problem-solution statement, or distinct persuasive argument. A single sentence may contain multiple meaning units.
            `;

            const modeInstruction = mode === 'quick'
               ? "After analyzing the *entire* text, extract *only* the 5 *most strategically important* meaning units from anywhere in the text. Do not just take the first 5."
               : (mode === 'medium'
                    ? "After analyzing the *entire* text, extract *only* the 10 *most strategically important* meaning units from anywhere in the text. Do not just take the first 10."
                    : "Deconstruct the *entire* text into *all* its meaning units, in the order they appear.");

            const outputInstruction = "Your output MUST be a JSON array of strings, with no other text, commentary, or explanation.";
            return `${coreInstruction}\n\n${modeInstruction}\n\n${outputInstruction}\n\nText to analyze:\n"""${text}"""\n\nOutput only the JSON array.`;
        };

        // --- [v2.2] S-Class í”¼ë“œë°± í”„ë¡¬í”„íŠ¸ (í”¼ë“œë°± 3ë²ˆ í•­ëª© ë°˜ì˜) ---
        const FEEDBACK_PROMPT = (userAnalyses) => {
            return `
                You are an S-Class Senior Marketer at 'Isanghan Marketing', a 'Jjokegi Theory' master. Your task is to act as an S-Class Coach providing a detailed 1:1 code review for a junior marketer's training submission.
                Your feedback must be mercilessly sharp, logical, and strategic, but ultimately **constructive and motivational**, aimed at fostering rapid **growth**. Do not be polite or vague. Be direct and analytical, **focusing on growth opportunities**.
                **All output text (summaries, plans, feedback) MUST be in KOREAN and contain NO markdown.**

                You will evaluate the user's submitted 'thought process' (user_analysis) for each 'original_chunk'.

                **Your process:**
                1.  Iterate through the *entire* \`userAnalyses\` array (which contains ${userAnalyses.length} items).
                2.  For **EACH** item, you MUST generate a \`specific_feedback\` string in KOREAN.
                3.  This \`specific_feedback\` MUST evaluate the user's analysis based on these S-Class criteria:
                    * **[ë³¸ëŠ¥/ë°˜ë°•]** ê³ ê°ì˜ í•µì‹¬ 'ë³¸ëŠ¥(ë‘ë ¤ì›€, ìš•ë§, LF8)'ì„ ê¿°ëš«ì—ˆëŠ”ê°€? ì˜ˆìƒ 'ë°˜ë°•'ì„ ë‚ ì¹´ë¡­ê²Œ ì œê±°í–ˆëŠ”ê°€?
                    * **[ì‹¬ë¦¬/ì „ëµ]** ì‚¬ìš©ëœ ì‹¬ë¦¬í•™ì  ì›ë¦¬ë‚˜ ë§ˆì¼€íŒ… ì „ëµ(ê°€ì¹˜ ì¦ëª…, í”„ë ˆì´ë° ë“±)ì´ ëª…í™•í•˜ê³  ì˜ë„ì ì¸ê°€?
                    * **[ê³ ê° ì„±ê³µ]** ì´ ë¶„ì„ì´ ê¶ê·¹ì ì¸ 'ê³ ê° ì„±ê³µ' ë° 'ë§¤ì¶œ'ì— ì–´ë–»ê²Œ ê¸°ì—¬í•˜ëŠ”ì§€ ì—°ê²°í–ˆëŠ”ê°€?
                    * **[ê°œì„ ì ]** (ê°€ì¥ ì¤‘ìš”) ì´ ë¶„ì„ì´ ì™œ ë¶€ì¡±í•œì§€, ë˜ëŠ” ë” ë‚ ì¹´ë¡­ê²Œ ë¶„ì„í–ˆë‹¤ë©´ ì–´ë• ì„ì§€ 'ê°œì„ í•  ì (Improvement)'ì„ **ë°˜ë“œì‹œ** í¬í•¨í•´ë¼. (ì˜ˆ: "Critique: ...ë¶„ì„ë§Œ ìˆê³ , ...ì‹¬ë¦¬ ì—°ê²°ì´ ë¹ ì¡ŒìŒ.")

                4.  After reviewing all items, generate the overall summary:
                    * \`score\`: An overall integer score (0-100) based on the quality of all analyses.
                    * \`summary_good_points\`: An array of 2-3 strings (KOREAN) summarizing the main strengths **of the user's *analyses* (ì‚¬ê³  ë¶„ì„)**. **Do NOT evaluate the original text itself.**
                    * \`summary_improvement_points\`: An array of 2-3 strings (KOREAN) summarizing the biggest weaknesses **of the user's *analyses* (ì‚¬ê³  ë¶„ì„)**. **Do NOT evaluate the original text itself.**
                    * \`personalized_action_plan\`: A single string (KOREAN) proposing a *specific, actionable, and motivational* next training goal based on the biggest weakness **in the user's analyses**. (This will be used as a placeholder in the UI).

                **Your output MUST be a single, raw JSON object in the following structure. Do not add any other text or markdown.**

                \`\`\`json
                {
                  "score": 0,
                  "summary_good_points": [],
                  "summary_improvement_points": [],
                  "personalized_action_plan": "",
                  "detailed_review": [
                    {
                      "original_chunk": "...",
                      "user_analysis": "...",
                      "specific_feedback": "..."
                    }
                  ]
                }
                \`\`\`

                **User's Analyses to evaluate:**
                ${JSON.stringify(userAnalyses, null, 2)}
            `;
        };
        // --- [END v2.2] S-Class AI Prompts ---


        // --- DOM Elements ---
        const inputSection = document.getElementById('input-section');
        const analysisSection = document.getElementById('analysis-section');
        const feedbackReportSection = document.getElementById('feedback-report-section');
        
        const errorBanner = document.getElementById('error-banner');
        const errorMessage = document.getElementById('error-message');
        const errorClose = document.getElementById('error-close');
        const dynamicLoader = document.getElementById('dynamic-loader');
        const loaderText = document.getElementById('loader-text');

        const textInput = document.getElementById('text-input');
        const charCounter = document.getElementById('char-counter');
        const courseOptionsContainer = document.querySelector('.course-options');
        const courseOptions = document.querySelectorAll('.course-option');
        const startSplitButton = document.getElementById('start-split-button');
        
        // [v2.0] í›ˆë ¨ ì„¹ì…˜ ìš”ì†Œ
        const analysisInputsContainer = document.getElementById('analysis-inputs');
        const progressIndicator = document.getElementById('progress-indicator');
        const nextChunkButton = document.getElementById('next-chunk-button'); // v2.0 ë²„íŠ¼ ID ë³€ê²½
        
        const resetButton = document.getElementById('reset-button');
        const downloadPdfButton = document.getElementById('download-pdf-button'); // [v2.2]

        // [v2.1] í”¼ë“œë°± ë¦¬í¬íŠ¸ ìš”ì†Œ (ì—…ë°ì´íŠ¸)
        const feedbackScoreEl = document.getElementById('feedback-score');
        const feedbackSummaryEl = document.getElementById('feedback-summary');
        // const feedbackChartCanvas = document.getElementById('feedback-radar-chart'); // [DELETED]
        const detailedReviewContainer = document.getElementById('detailed-review-container'); // [NEW]
        const goodPointsList = document.getElementById('good-points-list'); // (ìš”ì•½)
        const improvementPointsList = document.getElementById('improvement-points-list'); // (ìš”ì•½)
        // const actionPlanText = document.getElementById('action-plan-text'); // [v2.1] (DELETED)
        
        // [v2.1] ì•„ì´ë””ì–´ 6: ì†Œí¬ë¼í…ŒìŠ¤ì‹ ì§ˆë¬¸ ë°°ì—´
        const socraticQuestions = [
            "ì´ë²ˆ í›ˆë ¨ì—ì„œ ë“œëŸ¬ë‚œ ë‚˜ì˜ ê³ ì§ˆì ì¸ 'ìƒê°ì˜ íŒ¨í„´'ì€ ë¬´ì—‡ì´ì—ˆë‚˜?",
            "ë‹¤ìŒ í›ˆë ¨ì—ì„œ ì˜ì‹ì ìœ¼ë¡œ ë‹¤ë¥´ê²Œ ì‹œë„í•´ ë³¼ ë‹¨ í•œ ê°€ì§€ëŠ” ë¬´ì—‡ì¸ê°€?",
            "ì˜¤ëŠ˜ ë°›ì€ 1:1 ì½”ì¹­ ì¤‘ ê°€ì¥ ë¼ˆì•„í”ˆ(í•µì‹¬ì ì¸) í”¼ë“œë°±ì€ ë¬´ì—‡ì¸ê°€?",
            "ì´ í”¼ë“œë°±ì„ ë‚´ì¼ ì‘ì„±í•  OOO ì½˜í…ì¸ ì— ì–´ë–»ê²Œ ì ìš©í•  ìˆ˜ ìˆì„ê¹Œ?"
        ];

        // --- [v2.0] ì „ì—­ ìƒíƒœ ë³€ìˆ˜ ---
        let selectedCourse = null;
        let originalChunks = [];
        let userAnalyses = []; // [v2.0] ì‚¬ìš©ìì˜ ëª¨ë“  ë¶„ì„ì„ ì €ì¥
        let currentChunkIndex = 0; // [v2.0] í˜„ì¬ í›ˆë ¨ ì¤‘ì¸ ì²­í¬ ì¸ë±ìŠ¤
        // let feedbackChart = null; // [DELETED]
        let loaderInterval = null;

        // --- Event Listeners ---
        textInput.addEventListener('input', () => {
            updateButtonState();
            updateCharCounter();
        });
        errorClose.addEventListener('click', () => errorBanner.classList.add('hidden'));

        courseOptions.forEach(option => {
            option.addEventListener('click', () => {
                courseOptions.forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedCourse = option.dataset.course;
                updateButtonState();
            });
        });

        startSplitButton.addEventListener('click', handleStartSplit);
        nextChunkButton.addEventListener('click', handleNextChunk); // [v2.0]
        resetButton.addEventListener('click', resetUI);
        downloadPdfButton.addEventListener('click', handleDownloadPDF); // [v2.2]

        // [v2.1] ì•„ì´ë””ì–´ 4: 'ê°€ì¥ ì¤‘ìš”í•œ í•œ ê°€ì§€' ê¸€ì ìˆ˜ ì¹´ìš´í„°
        document.addEventListener('input', function(e) {
            if (e.target.id === 'action-plan-input') {
                const length = e.target.value.length;
                const counter = document.getElementById('action-plan-counter');
                if (counter) {
                    counter.textContent = `${length} / 140ì`;
                }
            }
        });

        // [v2.1] ì•„ì´ë””ì–´ 5: 'í”¼ë“œë°±-ì‹¤ì²œ' ì—°ê²° (ì´ë²¤íŠ¸ ìœ„ì„)
        detailedReviewContainer.addEventListener('click', function(e) {
            // í´ë¦­ëœ ìš”ì†Œ ë˜ëŠ” ê·¸ ë¶€ëª¨ê°€ .btn-use-as-lessonì¸ì§€ í™•ì¸
            const button = e.target.closest('.btn-use-as-lesson');
            if (button) {
                const feedbackText = button.dataset.feedbackText;
                const actionPlanInput = document.getElementById('action-plan-input');
                
                // [v2.1] ì•„ì´ë””ì–´ 5.3: í”¼ë“œë°± í…ìŠ¤íŠ¸ì—ì„œ í•µì‹¬ë§Œ ì¶”ì¶œ (ê°„ë‹¨í•œ ë²„ì „)
                // "Critique: " ë˜ëŠ” "ì§€ì : "ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë¶€ë¶„ì„ ì˜ë¼ë‚¼ ìˆ˜ ìˆìœ¼ë‚˜, ìš°ì„  ì›ë³¸ì„ ê·¸ëŒ€ë¡œ ë„£ìŠµë‹ˆë‹¤.
                let lessonText = feedbackText;
                // ì˜ˆì‹œ: "Critique: "ë¡œ ì‹œì‘í•˜ë©´ ê·¸ ë¶€ë¶„ ì œê±°
                if (lessonText.startsWith('Critique: ')) {
                    lessonText = lessonText.substring('Critique: '.length);
                }

                actionPlanInput.value = lessonText.substring(0, 140); // Max length
                actionPlanInput.focus();
                
                // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                const counter = document.getElementById('action-plan-counter');
                if (counter) {
                    counter.textContent = `${actionPlanInput.value.length} / 140ì`;
                }
                
                // [v2.1] ì•„ì´ë””ì–´ 5.3: ì‹œê°ì  í”¼ë“œë°± (ê¹œë¹¡ì„)
                actionPlanInput.style.transition = 'none';
                actionPlanInput.style.backgroundColor = '#f0f3ff'; // ì—°í•œ íŒŒë€ìƒ‰
                setTimeout(() => {
                    actionPlanInput.style.transition = 'background-color 0.3s ease';
                    actionPlanInput.style.backgroundColor = 'var(--white-color)';
                }, 150);
                
                // í•´ë‹¹ ì¸í’‹ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                actionPlanInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });


        // --- Core Functions ---

        function showError(message) {
            errorMessage.textContent = safeHtml(message);
            errorBanner.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function updateCharCounter() {
            const length = textInput.value.length;
            charCounter.textContent = `${length} / 50ì`;
            charCounter.classList.toggle('sufficient', length >= 50);
        }

        function updateButtonState() {
            startSplitButton.disabled = !(textInput.value.trim().length >= 50 && selectedCourse);
        }

        function showDynamicLoader(messages = ["ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."]) {
            let messageIndex = 0;
            loaderText.textContent = messages[messageIndex];
            if (loaderInterval) clearInterval(loaderInterval);
            loaderInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                loaderText.textContent = messages[messageIndex];
            }, 2500);
            dynamicLoader.classList.remove('hidden');
        }

        function hideDynamicLoader() {
            if (loaderInterval) clearInterval(loaderInterval);
            loaderInterval = null;
            dynamicLoader.classList.add('hidden');
        }

        // [v2.0] í›ˆë ¨ ì‹œì‘ (ìª¼ê°œê¸°)
        async function handleStartSplit() {
            const text = textInput.value.trim();
            if (text.length < 50) {
                 showError("í›ˆë ¨í•  í…ìŠ¤íŠ¸ë¥¼ 50ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");
                 return;
            }
            if (!selectedCourse) {
                showError("í›ˆë ¨ ì½”ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            startSplitButton.disabled = true;
            startSplitButton.textContent = 'AIê°€ ìª¼ê°œëŠ” ì¤‘...';
            inputSection.classList.add('hidden');
            showDynamicLoader([
                "AIê°€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",
                "ìµœì†Œ ì˜ë¯¸ ë‹¨ìœ„ë¡œ ìª¼ê°œê³  ìˆìŠµë‹ˆë‹¤...",
                "S-Class í›ˆë ¨ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤..."
            ]);
            errorBanner.classList.add('hidden');

            try {
                const chunks = await callGeminiApi(SPLIT_PROMPT(text, selectedCourse));
                originalChunks = chunks;
                userAnalyses = new Array(chunks.length).fill(null); // ë¶„ì„ ì €ì¥ ë°°ì—´ ì´ˆê¸°í™”
                currentChunkIndex = 0; // 0ë²ˆë¶€í„° ì‹œì‘
                
                displayCurrentChunk(); // ì²« ë²ˆì§¸ í›ˆë ¨ ì¹´ë“œ í‘œì‹œ
                
                analysisSection.classList.remove('hidden'); // í¬ì»¤ìŠ¤ ëª¨ë“œ ì„¹ì…˜ í‘œì‹œ
            } catch (error) {
                console.error('Error splitting text:', error);
                showError(`í…ìŠ¤íŠ¸ë¥¼ ìª¼ê°œëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                inputSection.classList.remove('hidden');
            } finally {
                startSplitButton.disabled = false;
                startSplitButton.textContent = 'ìª¼ê°œê¸° í›ˆë ¨ ì‹œì‘';
                hideDynamicLoader();
            }
        }

        // [v2.0] í˜„ì¬ í›ˆë ¨ ì²­í¬ í‘œì‹œ (í¬ì»¤ìŠ¤ ëª¨ë“œ UI)
        function displayCurrentChunk() {
            if (currentChunkIndex >= originalChunks.length) return; // ë²”ìœ„ ì´ˆê³¼ ë°©ì§€

            const chunk = originalChunks[currentChunkIndex];
            const savedAnalysis = userAnalyses[currentChunkIndex]?.user_analysis || ''; // ì´ì „ì— ì €ì¥ëœ ê°’ ë¡œë“œ
            const safeChunk = safeHtml(chunk);

            analysisInputsContainer.innerHTML = `
                <div class="chunk-card">
                    <div class="original-text-container">
                        <h4>#${currentChunkIndex + 1} í›ˆë ¨í•  ì›ë³¸</h4>
                        <p class="original-text">${safeChunk}</p>
                    </div>
                    <div class="analysis-input-container">
                        <h4>ë‚˜ì˜ í›ˆë ¨: ì‚¬ê³  ë¶„ì„</h4>
                        <textarea class="analysis-input" data-index="${currentChunkIndex}" placeholder="ì´ ë¬¸ì¥ì„ ì“´ ì˜ë„ëŠ” ë¬´ì—‡ì¸ê°€?\nê³ ê°ì˜ ì–´ë–¤ ë°˜ë°•ì„ ì œê±°í•˜ë ¤ í–ˆëŠ”ê°€?\nì–´ë–¤ ì‹¬ë¦¬í•™ì  ì›ë¦¬ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?">${safeHtml(savedAnalysis)}</textarea>
                    </div>
                </div>
            `;
            
            // ì§„í–‰ë¥  í‘œì‹œ
            progressIndicator.textContent = `${currentChunkIndex + 1} / ${originalChunks.length} í•­ëª© í›ˆë ¨ ì¤‘`;

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            if (currentChunkIndex === originalChunks.length - 1) {
                // [v2.1] ì•„ì´ë””ì–´ 10: ì–¸ì–´ ìˆ˜ì •
                nextChunkButton.textContent = 'ê²°ê³¼ ë¦¬í¬íŠ¸ ë³´ê¸°';
            } else {
                // [v2.1] ì•„ì´ë””ì–´ 10: ì–¸ì–´ ìˆ˜ì •
                nextChunkButton.textContent = 'ë‹¤ìŒ â”';
            }
        }

        // [v2.0] ë‹¤ìŒ í›ˆë ¨ / ë¦¬í¬íŠ¸ ì œì¶œ
        function handleNextChunk() {
            const currentTextarea = analysisInputsContainer.querySelector('.analysis-input');
            const analysisText = currentTextarea.value.trim();
            
            // í˜„ì¬ ë¶„ì„ ë‚´ìš© ì €ì¥
            userAnalyses[currentChunkIndex] = {
                original_chunk: originalChunks[currentChunkIndex],
                user_analysis: analysisText // ë¹ˆ ê°’ë„ ê·¸ëŒ€ë¡œ ì €ì¥
            };

            // ìœ íš¨ì„± ê²€ì‚¬ (v1.2ì™€ ë™ì¼í•˜ê²Œ ìœ ì§€, ë¹¨ê°„ í…Œë‘ë¦¬)
            currentTextarea.classList.remove('invalid');
            if (!analysisText) {
                currentTextarea.classList.add('invalid');
                showError('ì‚¬ê³  ë¶„ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return; // ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ
            }
            errorBanner.classList.add('hidden'); // ì„±ê³µ ì‹œ ì˜¤ë¥˜ ìˆ¨ê¹€


            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
            if (currentChunkIndex < originalChunks.length - 1) {
                currentChunkIndex++;
                displayCurrentChunk();
                window.scrollTo(0, 0); // ìƒˆ ì¹´ë“œ í‘œì‹œ ì‹œ ìƒë‹¨ìœ¼ë¡œ
            } else {
                // ë§ˆì§€ë§‰ í›ˆë ¨ì´ì—ˆìŠµë‹ˆë‹¤. í”¼ë“œë°± ë°›ê¸° ì‹¤í–‰
                handleGetFeedback();
            }
        }

        // [v2.0] í”¼ë“œë°± ë°›ê¸° (ë°ì´í„°ëŠ” ì´ë¯¸ userAnalysesì— ìˆìŒ)
        async function handleGetFeedback() {
            // v2.0: userAnalyses ë°°ì—´ì€ ì´ë¯¸ ìµœì‹  ìƒíƒœì„.
            // ëª¨ë“  í•­ëª©ì´ ì±„ì›Œì¡ŒëŠ”ì§€ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸ (handleNextChunkì—ì„œ ì´ë¯¸ í–ˆì§€ë§Œ ë°©ì–´ ì½”ë“œ)
            const allFilled = userAnalyses.every(analysis => analysis && analysis.user_analysis.trim().length > 0);
            
            if (!allFilled) {
                showError('ëª¨ë“  ì‚¬ê³  ë¶„ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ëˆ„ë½ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.');
                // ëˆ„ë½ëœ í•­ëª©ìœ¼ë¡œ ë˜ëŒì•„ê°€ëŠ” ë¡œì§ (ì„ íƒ ì‚¬í•­)
                const firstEmptyIndex = userAnalyses.findIndex(a => !a || !a.user_analysis.trim());
                if(firstEmptyIndex !== -1) {
                    currentChunkIndex = firstEmptyIndex;
                    displayCurrentChunk();
                    // í•´ë‹¹ ì…ë ¥ì°½ì— invalid í‘œì‹œ
                    setTimeout(() => {
                         const textarea = analysisInputsContainer.querySelector('.analysis-input');
                         if(textarea) textarea.classList.add('invalid');
                    }, 100);
                }
                return;
            }

            nextChunkButton.disabled = true;
            nextChunkButton.textContent = 'ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...';
            analysisSection.classList.add('hidden');
            showDynamicLoader([
                "S-Class ì½”ì¹˜ê°€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...",
                "ëª¨ë“  í›ˆë ¨ ë‚´ìš©ì„ ì •ë°€ ì±„ì  ì¤‘ì…ë‹ˆë‹¤...",
                "1:1 ë§ì¶¤í˜• ì½”ì¹­ì„ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
            ]);
            errorBanner.classList.add('hidden');

            try {
                // v2.2: ìƒˆë¡œìš´ S-Class í”„ë¡¬í”„íŠ¸ í˜¸ì¶œ
                const feedback = await callGeminiApi(FEEDBACK_PROMPT(userAnalyses));
                displayFeedbackReport(feedback); // v2.1: ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ í‘œì‹œ í•¨ìˆ˜
                feedbackReportSection.classList.remove('hidden');
                window.scrollTo(0, 0);
            } catch (error) {
                console.error('Error getting feedback:', error);
                showError(`í”¼ë“œë°±ì„ ë°›ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                analysisSection.classList.remove('hidden');
            } finally {
                nextChunkButton.disabled = false;
                // [v2.2] FIX: ë¡œë”ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ë²„ê·¸ ìˆ˜ì •
                hideDynamicLoader();
            }
        }

        // --- [v2.1] Display Feedback Report (ì•„ì´ë””ì–´ 1, 2, 4, 5, 6 ì ìš©) ---
         function displayFeedbackReport(feedback) {
            if (typeof feedback !== 'object' || feedback === null || !feedback.detailed_review) {
                console.error("Invalid feedback format:", feedback);
                showError('AIë¡œë¶€í„° ìœ íš¨í•œ JSON í”¼ë“œë°±ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (detailed_review ëˆ„ë½)');
                analysisSection.classList.remove('hidden');
                return;
            }

            // v2.0: ìƒˆë¡œìš´ JSON êµ¬ì¡°ì—ì„œ ë°ì´í„° ì¶”ì¶œ
            const {
                score = 0,
                summary_good_points = [],
                summary_improvement_points = [],
                personalized_action_plan = 'ë‹¤ìŒ í›ˆë ¨ì—ì„œ ë³´ì™„ì ì„ ê°œì„ í•´ë³´ì„¸ìš”.', // [v2.1] ì•„ì´ë””ì–´ 4: Placeholderìš©
                detailed_review = []
             } = feedback;

            // 1. ì ìˆ˜ ë° ì´í‰ ìš”ì•½
            let scoreClass = 'score-c';
            if (score >= 85) scoreClass = 'score-s';
            else if (score >= 60) scoreClass = 'score-a';
            else if (score >= 40) scoreClass = 'score-b';

            // [v2.1] ì•„ì´ë””ì–´ 2: ë™ê¸°ë¶€ì—¬ ìš”ì•½ë¬¸ìœ¼ë¡œ ë³€ê²½
            let summary = 'ê´œì°®ìŠµë‹ˆë‹¤. ëª¨ë“  ë§ˆìŠ¤í„°ë„ ì´ ë‹¨ê³„ì—ì„œ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. 1:1 ì½”ì¹­ì„ ì„±ì¥ì˜ ë°œíŒìœ¼ë¡œ ì‚¼ìœ¼ì„¸ìš”.';
            if (score >= 85) summary = 'ì••ë„ì ì¸ ë¶„ì„ì…ë‹ˆë‹¤! S-Classì˜ ë³¸ì§ˆì„ ê¿°ëš«ê³  ìˆìŠµë‹ˆë‹¤.';
            else if (score >= 60) summary = 'ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤. í•µì‹¬ì˜ 75%ë¥¼ íŒŒì•…í•˜ì…¨êµ°ìš”. ë‚˜ë¨¸ì§€ë¥¼ í•¨ê»˜ ë‹¤ë“¬ì–´ë³¼ê¹Œìš”?';
            else if (score >= 40) summary = 'ì„±ì¥ì˜ ê°€ëŠ¥ì„±ì´ ë³´ì…ë‹ˆë‹¤. 1:1 ì½”ì¹­ì„ í†µí•´ í•µì‹¬ì„ ì°¾ì•„ë³´ì„¸ìš”.';

            feedbackScoreEl.textContent = `${score}ì `;
            feedbackScoreEl.className = scoreClass;
            feedbackSummaryEl.textContent = safeHtml(summary);

             // 2. [DELETED] ë ˆì´ë” ì°¨íŠ¸
             // renderRadarChart(criteria_scores);

             // 3. [NEW] 1:1 ìƒì„¸ ì½”ì¹­ ë¦¬ìŠ¤íŠ¸ ìƒì„±
             detailedReviewContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
             detailed_review.forEach((review, index) => {
                 const analysisHtml = review.user_analysis
                    ? `<p>${safeHtml(review.user_analysis)}</p>`
                    : `<p class="empty-analysis">ë¶„ì„ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
                 
                 // [v2.2] ê°€ë…ì„± ê°œì„ 
                 const rawFeedback = review.specific_feedback;
                 const formattedFeedback = formatFeedbackText(rawFeedback); // í¬ë§·íŒ… í•¨ìˆ˜ ì‚¬ìš©

                 const cardHtml = `
                    <div class="review-card">
                        <div class="review-card-header">
                            <h4>#${index + 1} ì›ë³¸: "${safeHtml(review.original_chunk.substring(0, 40))}..."</h4>
                        </div>
                        <div class="review-card-body">
                            <div class="user-analysis-box">
                                <h5>ë‚˜ì˜ í›ˆë ¨ ë‚´ìš©</h5>
                                ${analysisHtml}
                            </div>
                            <div class="coach-feedback-box">
                                <h5>S-Class ì½”ì¹­</h5>
                                <p>${formattedFeedback}</p> <button class="btn-use-as-lesson" data-feedback-text="${safeHtml(rawFeedback)}"> + ì´ êµí›ˆì„ ë‚˜ì˜ 'Next Step'ìœ¼ë¡œ ì‚¼ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                 `;
                 detailedReviewContainer.innerHTML += cardHtml;
             });


            // 4. (ìš”ì•½) ìƒì„¸ í”¼ë“œë°± ëª©ë¡ í‘œì‹œ
            goodPointsList.innerHTML = summary_good_points.length > 0
                ? summary_good_points.map(p => `<li>${safeHtml(p)}</li>`).join('')
                : '<li>ìš”ì•½ëœ ê°•ì ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                
            improvementPointsList.innerHTML = summary_improvement_points.length > 0
                ? summary_improvement_points.map(p => `<li>${safeHtml(p)}</li>`).join('')
                : '<li>ìš”ì•½ëœ ë³´ì™„ì ì´ ì—†ìŠµë‹ˆë‹¤.</li>';

             // 5. [v2.1] ì•„ì´ë””ì–´ 4: ì•¡ì…˜ í”Œëœ (AI ì œì•ˆì„ Placeholderë¡œ ì‚¬ìš©)
             const actionPlanInput = document.getElementById('action-plan-input');
             if(actionPlanInput) {
                actionPlanInput.placeholder = safeHtml(personalized_action_plan);
             }
             
             // 6. [v2.1] ì•„ì´ë””ì–´ 6: ì†Œí¬ë¼í…ŒìŠ¤ì‹ ì§ˆë¬¸ ì„¤ì •
             const questionEl = document.getElementById('socratic-question');
             if (questionEl) {
                 const randomIndex = Math.floor(Math.random() * socraticQuestions.length);
                 questionEl.textContent = socraticQuestions[randomIndex];
             }
        }

        // --- [DELETED v2.0] Render Radar Chart ---
        /*
        function renderRadarChart(scores) { ... }
        */

        // --- [v2.1] Reset UI Function (ì—…ë°ì´íŠ¸) ---
         function resetUI() {
            inputSection.classList.remove('hidden');
            analysisSection.classList.add('hidden');
            feedbackReportSection.classList.add('hidden');
            errorBanner.classList.add('hidden');
            hideDynamicLoader();

            textInput.value = '';
            courseOptions.forEach(o => o.classList.remove('selected'));
            selectedCourse = null;
            
            // v2.0: ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
            originalChunks = [];
            userAnalyses = [];
            currentChunkIndex = 0;
            
            analysisInputsContainer.innerHTML = ''; // í›ˆë ¨ ì¹´ë“œ ì œê±°
            detailedReviewContainer.innerHTML = ''; // v2.0: ìƒì„¸ ë¦¬ë·° ì œê±°
            
            // [v2.1] ì•„ì´ë””ì–´ 4, 6: ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const actionPlanInput = document.getElementById('action-plan-input');
            if(actionPlanInput) actionPlanInput.value = '';
            const selfCoachingInput = document.getElementById('self-coaching-input');
            if(selfCoachingInput) selfCoachingInput.value = '';
            const actionPlanCounter = document.getElementById('action-plan-counter');
            if(actionPlanCounter) actionPlanCounter.textContent = '0 / 140ì';


            progressIndicator.textContent = '';
            nextChunkButton.textContent = 'ë‹¤ìŒ â”'; // v2.1: ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            nextChunkButton.disabled = false; // v2.0: ë²„íŠ¼ í™œì„±í™”

            startSplitButton.disabled = true;
            updateCharCounter();
            
            window.scrollTo(0, 0);
         }

        // --- API CALL LOGIC (v1.2ì™€ ë™ì¼, ì´ë¯¸ ê°•ë ¥í•¨) ---
        async function callGeminiApi(prompt) {
            console.log("Sending prompt to API:", prompt);

            // API í‚¤ ìœ íš¨ì„± ê²€ì‚¬
            if (GEMINI_API_KEY === "AIzaSyCVTLte-n_F-83vTq3P1Fc16NzGXdKaIYI") {
                // NOTE: This is a placeholder key. The original key was kept as requested by the prompt.
                if (GEMINI_API_KEY.includes("YOUR_") || GEMINI_API_KEY.length < 30) {
                     showError("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ 'GEMINI_API_KEY' ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.");
                     throw new Error("API Key not set.");
                }
            }

             let retries = 0;
             const maxRetries = 3;
             const baseDelay = 1000;

             while(retries < maxRetries) {
                 try {
                     const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                responseMimeType: "application/json",
                            },
                            safetySettings: [
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                            ]
                        })
                    });

                    if (!response.ok) {
                         if (response.status === 429 || response.status >= 500) {
                             retries++;
                             if (retries >= maxRetries) throw new Error(`API í˜¸ì¶œì´ ${maxRetries}ë²ˆì˜ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (Status: ${response.status}).`);
                             const delay = baseDelay * Math.pow(2, retries);
                             console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms... (${retries}/${maxRetries})`);
                             await new Promise(resolve => setTimeout(resolve, delay));
                             continue;
                         } else {
                            const errorBody = await response.text();
                            console.error("API Error Body:", errorBody);
                            throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                         }
                    }

                    const data = await response.json();

                     if (!data.candidates || data.candidates.length === 0 ||!data.candidates[0].content ||!data.candidates[0].content.parts || data.candidates[0].content.parts.length === 0) {
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
                            throw new Error("AIê°€ ì•ˆì „ìƒì˜ ì´ìœ ë¡œ ì‘ë‹µì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.");
                        }
                        if (data.promptFeedback && data.promptFeedback.blockReason) {
                             throw new Error(`API ìš”ì²­ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.promptFeedback.blockReason}`);
                        }
                         console.error("Invalid API Response Structure:", data);
                         throw new Error("AIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µ êµ¬ì¡°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }

                    const jsonString = data.candidates[0].content.parts[0].text;

                    try {
                        const parsedResult = JSON.parse(jsonString);
                        // v2.0: í”¼ë“œë°± í”„ë¡¬í”„íŠ¸ëŠ” 'detailed_review' í‚¤ë¥¼ í¬í•¨í•œ ê°ì²´ì—¬ì•¼ í•¨
                         if (prompt.includes('S-Class Coach') && (typeof parsedResult !== 'object' || parsedResult === null || !parsedResult.detailed_review)) {
                             console.error("Feedback prompt did not return a valid object with 'detailed_review':", parsedResult);
                             throw new Error("AIê°€ í”¼ë“œë°± ê²°ê³¼ë¥¼ ê°ì²´ í˜•ì‹(detailed_review í¬í•¨)ìœ¼ë¡œ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                         }
                        return parsedResult;
                    } catch (parseError) {
                        console.error("Failed to parse JSON response:", jsonString, parseError);
                        throw new Error("AIê°€ ìœ íš¨í•œ JSON í˜•ì‹ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }

                } catch (error) {
                    console.error("API Error during fetch or processing:", error);
                     if (retries >= maxRetries) throw error;
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('API Key not set')) {
                        // API í‚¤ ë¯¸ì„¤ì • ì‹œ ì¬ì‹œë„ ì¤‘ì§€
                        if (error.message.includes('API Key not set')) throw error;

                        retries++;
                        const delay = baseDelay * Math.pow(2, retries);
                        console.warn(`API/Network error. Retrying in ${delay}ms... (${retries}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        throw error;
                    }
                }
             }
             throw new Error(`API í˜¸ì¶œì´ ${maxRetries}ë²ˆì˜ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
        }

        // [v2.2] PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        async function handleDownloadPDF() {
            const { jsPDF } = window.jspdf;
            const reportSection = document.getElementById('feedback-report-section');
            
            // ë¡œë” í‘œì‹œ (ë‹¤ìš´ë¡œë“œ ì¤‘)
            showDynamicLoader(["ë¦¬í¬íŠ¸ë¥¼ PDFë¡œ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."]);
            downloadPdfButton.disabled = true;
            downloadPdfButton.textContent = 'ìƒì„± ì¤‘...';
        
            try {
                // html2canvasë¡œ ë¦¬í¬íŠ¸ ì„¹ì…˜ ìº¡ì²˜
                const canvas = await html2canvas(reportSection, {
                    scale: 2, // ê³ í•´ìƒë„ ìº¡ì²˜
                    useCORS: true,
                    windowWidth: document.documentElement.scrollWidth,
                    windowHeight: document.documentElement.scrollHeight
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                // PDF í˜ì´ì§€ í¬ê¸°ë¥¼ ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ì¶¤
                const pdf = new jsPDF({
                    orientation: imgWidth > imgHeight ? 'l' : 'p', // 'landscape' or 'portrait'
                    unit: 'px',
                    format: [imgWidth, imgHeight]
                });
        
                // PDFì— ì´ë¯¸ì§€ ì¶”ê°€
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // íŒŒì¼ ì €ì¥
                pdf.save(`Jjokegi_Master_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        
            } catch (error) {
                console.error('Error generating PDF:', error);
                showError('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ë¡œë” ìˆ¨ê¸°ê¸°
                hideDynamicLoader();
                downloadPdfButton.disabled = false;
                downloadPdfButton.textContent = 'ğŸ“ˆ ë¦¬í¬íŠ¸ PDFë¡œ ì €ì¥';
            }
        }


        // [v2.2] í”¼ë“œë°± í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°œì„  í—¬í¼
        function formatFeedbackText(text) {
            if (!text) return '';
            // 1. í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            let safeText = safeHtml(text);
            
            // 2. ì´ìŠ¤ì¼€ì´í”„ëœ í…ìŠ¤íŠ¸ì—ì„œ [í‚¤ì›Œë“œ] íŒ¨í„´ì„ ì°¾ì•„ HTML íƒœê·¸ë¡œ êµì²´í•©ë‹ˆë‹¤.
            //    ì •ê·œì‹: ëŒ€ê´„í˜¸([)ë¡œ ì‹œì‘í•˜ê³ , ëŒ€ê´„í˜¸(])ê°€ ì•„ë‹Œ ëª¨ë“  ë¬¸ì(+)ê°€ ë’¤ë”°ë¥´ê³ , ëŒ€ê´„í˜¸(])ë¡œ ëë‚˜ëŠ” íŒ¨í„´
            safeText = safeText.replace(/\[([^\]]+)\]/g, '<br><strong>[$1]</strong>');
            
            // 3. ë§Œì•½ í…ìŠ¤íŠ¸ê°€ <br>ë¡œ ì‹œì‘í•œë‹¤ë©´ ì œê±°í•©ë‹ˆë‹¤.
            if (safeText.startsWith('<br>')) {
                safeText = safeText.substring(4);
            }
            return safeText;
        }


        // Helper function for safe HTML display
        function safeHtml(text) {
          // [v2.1] ì•„ì´ë””ì–´ 5: data- ì†ì„±ì— ë“¤ì–´ê°ˆ í…ìŠ¤íŠ¸ëŠ” ë”°ì˜´í‘œë„ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          if (typeof text !== 'string') return '';
          return text.replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
        }

        // ì´ˆê¸° ë¡œë“œ
        updateCharCounter();
    </script>
</body>
</html>